# å®ˆæŠ¤è¿›ç¨‹å’Œçº¿ç¨‹:card_index: 

## 1. å®ˆæŠ¤è¿›ç¨‹:rabbit: 

### 1.1 å®ˆæŠ¤è¿›ç¨‹ä»‹ç»

**Daemon**ï¼ˆç²¾çµï¼‰è¿›ç¨‹ï¼Œæ˜¯Linuxä¸­çš„åå°æœåŠ¡è¿›ç¨‹ï¼Œé€šå¸¸ç‹¬ç«‹äºæ§åˆ¶ç»ˆç«¯å¹¶ä¸”å‘¨æœŸæ€§åœ°æ‰§è¡ŒæŸç§ä»»åŠ¡æˆ–ç­‰å¾…å¤„ç†æŸäº›å‘ç”Ÿçš„äº‹ä»¶ã€‚  
ä¸€èˆ¬é‡‡å–ä»¥dç»“å°¾çš„åå­—ï¼Œå¦‚ï¼š`vsftpd` 

Linuxåå°çš„ä¸€äº›ç³»ç»ŸæœåŠ¡è¿›ç¨‹ï¼Œæ²¡æœ‰æ§åˆ¶ç»ˆç«¯ï¼Œä¸èƒ½ç›´æ¥å’Œç”¨æˆ·äº¤äº’ã€‚ä¸å—ç”¨æˆ·ç™»å½•ã€æ³¨é”€çš„å½±å“ï¼Œä¸€ç›´åœ¨è¿è¡Œç€ï¼Œä»–ä»¬éƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹ã€‚  
å¦‚ï¼šé¢„è¯»å…¥ç¼“è¾“å‡ºæœºåˆ¶çš„å®ç°ï¼›`ftp` æœåŠ¡å™¨ï¼›`nfs` æœåŠ¡å™¨ç­‰ã€‚

ã€:ticket:ã€‘**å®ˆæŠ¤è¿›ç¨‹ç‰¹ç‚¹**   
            :one: Linuxåå°æœåŠ¡è¿›ç¨‹  :two: ç‹¬ç«‹äºæ§åˆ¶ç»ˆç«¯  :three: å‘¨æœŸæ€§çš„æ‰§è¡ŒæŸç§ä»»åŠ¡  :four: ä¸å—ç”¨æˆ·ç™»å½•å’Œæ³¨é”€çš„å½±å“  :five: ä¸€èˆ¬é‡‡ç”¨dç»“å°¾çš„åå­—

### 1.2 è¿›ç¨‹ç»„å’Œä¼šè¯

- **è¿›ç¨‹ç»„** 
  - **è¿›ç¨‹ç»„æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿›ç¨‹çš„é›†åˆ**ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œå¼•å…¥è¿›ç¨‹ç»„æ˜¯ä¸ºäº†è¿›åŒ–å¯¹è¿›ç¨‹çš„ç®¡ç†ã€‚å½“çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œé»˜è®¤å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„

ã€:boxing_glove:ã€‘**è¿›ç¨‹ç»„ID == ç¬¬ä¸€ä¸ªè¿›ç¨‹IDï¼ˆç»„é•¿è¿›ç¨‹ï¼‰**  
             å¦‚çˆ¶è¿›ç¨‹åˆ›å»ºäº†å¤šä¸ªå­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹å’Œå¤šä¸ªå­è¿›ç¨‹åŒå±äºä¸€ä¸ªç»„ï¼Œè€Œä¸”çˆ¶è¿›ç¨‹æ˜¯è¿›ç¨‹ç»„é‡Œçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥çˆ¶è¿›ç¨‹å°±æ˜¯è¿™ä¸ªç»„çš„ç»„é•¿  
             ç»„é•¿ID == çˆ¶è¿›ç¨‹ID

ã€:warning:ã€‘`kill -SIGKILL -è¿›ç¨‹ç»„ID(è´Ÿ)` æ€æ­»è¿›ç¨‹ç»„æ‰€æœ‰è¿›ç¨‹

ã€:four_leaf_clover:ã€‘è¿›ç¨‹ç»„ç”Ÿå­˜æœŸï¼šä»è¿›ç¨‹åˆ›å»ºåˆ°æœ€åä¸€ä¸ªè¿›ç¨‹ç¦»å¼€  
            åªè¦è¿›ç¨‹ç»„ä¸­æœ‰ä¸€ä¸ªè¿›ç¨‹å­˜åœ¨ï¼Œè¿›ç¨‹ç»„å°±å­˜åœ¨ï¼Œä¸ç»„é•¿è¿›ç¨‹æ˜¯å¦ç»ˆæ­¢æ— å…³

- **ä¼šè¯** 
  - **ä¸€ä¸ªä¼šè¯æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ç»„çš„é›†åˆ** 

ã€:key:ã€‘åˆ›å»ºä¼šè¯çš„è¿›ç¨‹ä¸èƒ½æ˜¯è¿›ç¨‹ç»„ç»„é•¿  
             åˆ›å»ºä¼šè¯çš„è¿›ç¨‹æˆä¸ºä¸€ä¸ªè¿›ç¨‹çš„ç»„é•¿è¿›ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæˆä¸ºä¼šè¯çš„ä¼šé•¿  
             éœ€è¦rootæƒé™ï¼ˆæœ‰çš„ç³»ç»Ÿä¸éœ€è¦ï¼‰  
             æ–°åˆ›å»ºçš„ä¼šè¯ä¸¢å¼ƒåŸæœ‰çš„æ§åˆ¶ç»ˆç«¯

ã€:tractor:ã€‘åˆ›å»ºæ–°ä¼šè¯  
             å…ˆè°ƒç”¨ `fork` ï¼Œçˆ¶è¿›ç¨‹ç»ˆæ­¢ï¼Œå­è¿›ç¨‹è°ƒç”¨ `setsid` å‡½æ•°

`ps ajx` æŸ¥çœ‹è¿›ç¨‹ç»„IDå’Œä¼šè¯ID  
`PPID` çˆ¶è¿›ç¨‹ID  `PID` è¿›ç¨‹ID  `PGID` è¿›ç¨‹ç»„ID `SID` ä¼šè¯ID

```Linux
[xfk@centos COMP_SIGNAL]$ ps ajx
  PPID    PID   PGID    SID TTY       TPGID STAT   UID   TIME COMMAND
     0      1      1      1 ?            -1 Ss       0   0:03 /usr/lib/systemd/sys
     0      2      0      0 ?            -1 S        0   0:00 [kthreadd]
     2      3      0      0 ?            -1 S        0   0:00 [ksoftirqd/0]
  ...
```

### 1.3 åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ¨¡å‹

<font color=deeppink>**ç¬¬ä¸€æ­¥ï¼šfork å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹é€€å‡º**</font>   
               ä¿è¯å­è¿›ç¨‹IDä¸æ˜¯è¿›ç¨‹ç»„ID

<font color=deeppink>**ç¬¬äºŒæ­¥ï¼šå­è¿›ç¨‹è°ƒç”¨ setsid å‡½æ•°åˆ›å»ºæ–°ä¼šè¯**</font>  
                è¯¥è¿›ç¨‹æˆä¸ºæ–°ä¼šè¯çš„é¦–è¿›ç¨‹ï¼Œæ˜¯ä¼šè¯çš„ä¼šé•¿  
                è¯¥è¿›ç¨‹æˆä¸ºä¸€ä¸ªæ–°è¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ï¼Œæ˜¯è¿›ç¨‹ç»„ç»„é•¿  
                ä¸å—æ§åˆ¶ç»ˆç«¯çš„å½±å“

ç¬¬ä¸‰æ­¥ï¼šæ”¹å˜å½“å‰å·¥ä½œç›®å½• chdir ï¼ˆéå¿…è¦ï¼‰

ç¬¬å››æ­¥ï¼šé‡è®¾æ–‡ä»¶æ©ç ï¼ˆéå¿…è¦ï¼‰ `mode & ~umask`   
                å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ©ç ï¼Œå—åˆ°çº¦æŸã€‚  
				>>>ç›´æ¥è®¾ç½® `umask(0000);` 

ç¬¬äº”æ­¥ï¼šå…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼ˆéå¿…è¦ï¼‰  
                `close(STDIN_FILENO);` `close(STDOUT_FILENO);` `close(STDERR_FILENO);` 

<font color=deeppink>**ç¬¬å…­æ­¥ï¼šæ‰§è¡Œæ ¸å¿ƒæ“ä½œ**</font>  
                å®ˆæŠ¤è¿›ç¨‹çš„æ ¸å¿ƒä»£ç é€»è¾‘

```C
  1 //åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <sys/stat.h>
  7 #include <fcntl.h>
  8 #include <unistd.h>
  9 #include <signal.h>
 10 #include <sys/time.h>
 11 #include <time.h>
 12 
 13 void func(int signo)
 14 {
 15     //æ‰“å¼€æ–‡ä»¶
 16     int fd = open("daemon.log", O_RDWR | O_CREAT | O_APPEND, 0755);
 17     if(fd<0)
 18     {
 19         return;
 20     }
 21 
 22     //è·å–å½“å‰ç³»ç»Ÿæ—¶é—´
 23     time_t t;
 24     time(&t);
 25     char *p = ctime(&t);
 26 
 27     //å°†æ—¶é—´å†™å…¥æ–‡ä»¶
 28     write(fd, p, strlen(p));
 29 
 30     //å…³é—­æ–‡ä»¶
 31     close(fd);
 32 }
 33 
 34 int main()
 35 {
 36     //åˆ›å»ºå­è¿›ç¨‹
 37     pid_t pid = fork();
 38     if(pid<0||pid>0)
 39     {
 40         exit(1);
 41     }
 42 
 43     //åˆ›å»ºä¼šè¯
 44     setsid();
 45 
 46     //ä¿®æ”¹å½“å‰å·¥ä½œç›®å½•ï¼ˆéå¿…è¦ï¼‰
 47     //chdir("pathname");
 48 
 49     //é‡è®¾æ–‡ä»¶æ©ç 
 50     umask(0000);
 51 
 52     //å…³é—­æ–‡ä»¶æè¿°ç¬¦
 53     close(STDIN_FILENO);
 54     close(STDOUT_FILENO);
 55     close(STDERR_FILENO);
 56 	//æ ¸å¿ƒæ“ä½œ
 57     //åˆ›å»ºä¿¡å·å¤„ç†å‡½æ•°
 58     struct sigaction act;
 59     act.sa_handler = func;
 60     act.sa_flags = 0;
 61     sigemptyset(&act.sa_mask);
 62     sigaction(SIGALRM, &act, NULL);
 63 
 64     //è®¾ç½®å®šæ—¶å™¨
 65     struct itimerval tm;
 66     tm.it_interval.tv_sec = 2;
 67     tm.it_interval.tv_usec = 0;
 68     tm.it_value.tv_sec = 3;
 69     tm.it_value.tv_usec = 0;
 70     setitimer(ITIMER_REAL, &tm, NULL);
 71 
 72     while(1)
 73     {
 74         sleep(1);
 75     }
 76     return 0;
 77 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos DAEMON]$ ps ajx | grep ./daemon
     1  13671  13671  13671 ?            -1 Ss    1000   0:00 ./daemon
 [xfk@centos DAEMON]$ tail -f daemon.log
 Tue Jan 24 20:56:36 2023
 Tue Jan 24 20:56:38 2023
 Tue Jan 24 20:56:40 2023
 Tue Jan 24 20:56:42 2023
 ^C
```

## 2. çº¿ç¨‹:zap: 

### 2.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹

è½»é‡çº§çš„è¿›ç¨‹ï¼ˆLWPï¼šlight weight processï¼‰ï¼Œåœ¨Linuxç¯å¢ƒä¸‹çº¿ç¨‹çš„æœ¬è´¨ä»æ˜¯è¿›ç¨‹ï¼Œè¿›ç¨‹å¯çœ‹æˆæ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è¿›ç¨‹

- è¿›ç¨‹ï¼šæ‹¥æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œæ‹¥æœ‰PCBï¼Œç›¸å½“äºç‹¬å±…

- çº¿ç¨‹ï¼šæœ‰PCBï¼Œä½†æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹ç©ºé—´ï¼Œç›¸å½“äºåˆç§Ÿ

ã€:bowling:ã€‘**ç³»ç»Ÿåˆ†é…èµ„æºçš„æœ€åŸºæœ¬å•ä½æ˜¯ï¼šè¿›ç¨‹**  
             **ç³»ç»Ÿè°ƒåº¦è¿›ç¨‹æ‰§è¡Œçš„æœ€å°å•ä½æ˜¯ï¼šçº¿ç¨‹**  
             å¤šä¸ªå­çº¿ç¨‹å’Œä¸»çº¿ç¨‹å…±äº«ä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œæœ‰ä¸€ä¸ªPIDï¼Œé€šè¿‡ä½¿ç”¨çº¿ç¨‹å·æ¥åŒºåˆ†ä¸åŒçš„çº¿ç¨‹  
             ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹æ‰§è¡Œå…ˆåä¸ä¸€å®šï¼Œçœ‹è°å…ˆæŠ¢åˆ°cpuèµ„æº

`ps -Lf pid` æŸ¥çœ‹æŒ‡å®šçº¿ç¨‹çš„LWPå·

```Linux
[xfk@centos DAEMON]$ ps -Lf 8763
UID         PID   PPID    LWP  C NLWP STIME TTY      STAT   TIME CMD
xfk        8763   8703   8763  0    1 Jan24 pts/1    Ss+    0:00 bash
```

ã€:rotating_light:ã€‘åˆ›å»ºè¿›ç¨‹ `fork` / åˆ›å»ºçº¿ç¨‹ `pthread_create` åº•å±‚å®ç°éƒ½æ˜¯è°ƒç”¨åŒä¸€ä¸ªå†…æ ¸å‡½æ•° `clone`   
             å¦‚æœå¤åˆ¶å¯¹æ–¹çš„åœ°å€ç©ºé—´ï¼Œé‚£ä¹ˆå°±äº§å‡ºä¸€ä¸ªè¿›ç¨‹ï¼›å¦‚æœå…±äº«å¯¹æ–¹çš„åœ°å€ç©ºé—´ï¼Œå°±äº§ç”Ÿä¸€ä¸ªçº¿ç¨‹

**Linuxå†…æ ¸æ˜¯ä¸åŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹çš„ï¼Œåªåœ¨ç”¨æˆ·å±‚é¢ä¸Šè¿›è¡ŒåŒºåˆ†**  
çº¿ç¨‹æ‰€æœ‰æ“ä½œå‡½æ•° `pthread_*` æ˜¯åº“å‡½æ•°ï¼Œè€Œéç³»ç»Ÿè°ƒç”¨ 

### 2.2 çº¿ç¨‹å…±äº«èµ„æº/éå…±äº«èµ„æº

- å…±äº«èµ„æºï¼š  
  :one: æ–‡ä»¶æè¿°ç¬¦è¡¨   
  :two: æ¯ç§ä¿¡å·çš„å¤„ç†æ–¹å¼   
  :three: å½“å‰å·¥ä½œç›®å½•   
  :four: ç”¨æˆ·IDå’Œç»„ID   
  :five: å†…å­˜å€ç©ºé—´

- éå…±äº«èµ„æºï¼š  
  :one: çº¿ç¨‹ID  
  :two: å¤„ç†å™¨ç°åœºå’Œæ ˆæŒ‡é’ˆï¼ˆå†…æ ¸æ ˆï¼‰  
  :three: ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼ˆç”¨æˆ·ç©ºé—´æ ˆï¼‰  
  :four: `errno` å˜é‡   
  :five: ä¿¡å·å±è”½å­—/è°ƒåº¦ä¼˜å…ˆçº§

### 2.3 çº¿ç¨‹ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹
  - æé«˜ç¨‹åºå¹¶å‘æ€§
  - å¼€é”€å°
  - æ•°æ®é€šä¿¡ã€å…±äº«æ•°æ®æ–¹ä¾¿
- ç¼ºç‚¹
  - åº“å‡½æ•°ï¼Œä¸ç¨³å®š
  - gdbè°ƒè¯•ã€ç¼–å†™å›°éš¾
  - å¯¹ä¿¡å·æ”¯æŒä¸å¥½

### 2.4 çº¿ç¨‹ç›¸å…³å‡½æ•°

```C
#include <pthread.h>
Compile and link with -pthread
```

#### pthread_createå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine) (void *), void *arg);` 
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
- å‡½æ•°å‚æ•°ï¼š
  - `pthread_t` ï¼šä¼ å‡ºå‚æ•°ï¼Œä¿å­˜ç³»ç»Ÿä¸ºæˆ‘ä»¬åˆ†é…å¥½çš„çº¿ç¨‹ID
  - `attr` ï¼šé€šå¸¸ä¼ NULLï¼Œè¡¨ç¤ºä½¿ç”¨çº¿ç¨‹é»˜è®¤å±æ€§
  - `start_routine` ï¼šå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘çº¿ç¨‹ä¸»å‡½æ•°ï¼ˆçº¿ç¨‹ä½“ï¼‰ï¼Œè¯¥å‡½æ•°è¿è¡Œç»“æŸï¼Œåˆ™çº¿ç¨‹ç»“æŸ
  - `arg` ï¼šçº¿ç¨‹ä¸»å‡½æ•°æ‰§è¡ŒæœŸé—´æ‰€ä½¿ç”¨çš„å‚æ•°

ã€:printer:ã€‘ä¸èƒ½ä½¿ç”¨ `perror` å‡½æ•°ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `strerror` å‡½æ•°  
             ä¸èƒ½ä½¿ç”¨ `exit/_exit` å‡½æ•°ï¼Œå¦åˆ™å¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡º

ã€:warning:ã€‘ç¼–è¯‘æ—¶é“¾æ¥åº“ `-lpthread` 

```C
  1 //åˆ›å»ºå­çº¿ç¨‹
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 void *threadfunc(void *arg)			//çº¿ç¨‹æ‰§è¡Œå‡½æ•°
 10 {
 11     printf("child thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 12 }
 13 
 14 int main()
 15 {
 16     //åˆ›å»ºå­çº¿ç¨‹
 17     pthread_t thread;
 18     int ret = pthread_create(&thread, NULL, threadfunc, NULL);
 19     if (ret!=0)
 20     {
 21         printf("pthread_create error, [%s]\n", strerror(ret));
 22         return -1;
 23     }
 24     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 25 
 26     sleep(1);
 27     return 0;
 28 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ gcc -o pthread_create pthread_create.c -lpthread
 [xfk@centos PTHREAD]$ ./pthread_create 
 main thread, pid==[17065], id==[140320903141184]
 child thread, pid==[17065], id==[140320894809856]
```

```C
  1 //åˆ›å»ºå­çº¿ç¨‹ï¼šå‚æ•°ä¼ é€’
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 struct A
 10 {
 11     int data;
 12     char buf[64];
 13 };
 14 
 15 void *threadfunc(void *arg)
 16 {
 17     //intå‚æ•°ä¼ é€’
 18     //int n = *(int *)arg;
 19     //printf("n==[%d]", n);
 20     //ç»“æ„ä½“å‚æ•°ä¼ é€’
 21     struct A *p = (struct A *)arg;
 22     printf("struct A:\n[%d][%s]\n", p->data, p->buf);
 23     printf("child thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 24 }
 25 
 26 int main()
 27 {
 28     int n = 10;
 29     struct A atest;
 30     memset(&atest, 0x00, sizeof(struct A));
 31     atest.data = 100;
 32     strcpy(atest.buf, "xfk tq");
 33     //åˆ›å»ºå­çº¿ç¨‹
 34     pthread_t thread;
 35     //int ret = pthread_create(&thread, NULL, threadfunc, &n);
 36     int ret = pthread_create(&thread, NULL, threadfunc, &atest);
 37     if (ret!=0)
 38     {   
 39         printf("pthread_create error, [%s]\n", strerror(ret));
 40         return -1;
 41     }
 42     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 43 
 44     sleep(1);
 45     return 0;
 46 }     
     
 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ gcc -o pthread_create_arg pthread_create_arg.c -lpthread
 [xfk@centos PTHREAD]$ ./pthread_create_arg 
 main thread, pid==[17699], id==[140652003301184]
 struct A:
 [100][xfk tq]
 child thread, pid==[17699], id==[140651994969856]
```

```C
  1 //å¾ªç¯åˆ›å»ºå­çº¿ç¨‹
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 void *threadfunc(void *arg)
 10 {
 11     int i = *(int *)arg;
 12     printf("[%d]:child thread, pid==[%d], id==[%ld]\n", i, getpid(), pthread_self());
 13 }
 14 
 15 int main()
 16 {
 17     //å¾ªç¯åˆ›å»ºå­çº¿ç¨‹
 18     int i = 0;					
 19     int n = 3;					
 20     int arr[5];					//å­çº¿ç¨‹å•ç‹¬è®¿é—®ç‹¬ç«‹å†…å­˜ç©ºé—´ï¼Œå¯å®ç°åŒºåˆ†
 21     int ret;
 22     pthread_t thread[5];
 23     for(i=0;i<n;i++)
 24     {
 25         arr[i] = i;
 26         int ret = pthread_create(&thread[i], NULL, threadfunc, &arr[i]);
 27         if (ret!=0)
 28         {
 29             printf("pthread_create error, [%s]\n", strerror(ret));
 30             return -1;
 31         }
 32     }
 33     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 34 
 35     sleep(1);
 36     return 0;
 37 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ ./pthread_create_loop
 main thread, pid==[11162], id==[140445466715968]
 [0]:child thread, pid==[11162], id==[140445458384640]
 [1]:child thread, pid==[11162], id==[140445449991936]
 [2]:child thread, pid==[11162], id==[140445441599232]
```

ã€:eyeglasses:ã€‘ä¼ é€’ `i` å˜é‡æ— æ³•åŒºåˆ†å­çº¿ç¨‹  
		     ç”±äºå…¶å†…å­˜ç©ºé—´åªæœ‰ä¸€å—ï¼Œè¢«æ‰€æœ‰å­çº¿ç¨‹å…±äº«  
             ä¸»çº¿ç¨‹åœ¨ä¸€ä¸ªcpuæ—¶é—´ç‰‡å†…å®Œæˆäº†æ‰€æœ‰å­çº¿ç¨‹çš„åˆ›å»ºï¼Œè€Œå­çº¿ç¨‹åç»­æ‰æ‰§è¡Œï¼Œæ­¤æ—¶å…±äº« `i=3` ï¼Œä½¿ç”¨ç‹¬ç«‹çš„å†…å­˜ç©ºé—´å¯å®ç°åŒºåˆ†

#### pthread_exitå‡½æ•°

åœ¨çº¿ç¨‹ä¸­ç¦æ­¢è°ƒç”¨ `exit` å‡½æ•°ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡ºï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `pthread_exit` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä½¿ä¸€ä¸ªçº¿ç¨‹é€€å‡º  
å¦‚æœä¸»çº¿ç¨‹è°ƒç”¨ `pthread_exit` å‡½æ•°ä¹Ÿä¸ä¼šä½¿æ•´ä¸ªè¿›ç¨‹é€€å‡ºï¼Œä¸å½±å“å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œ

- å‡½æ•°ä½œç”¨ï¼šå°†å•ä¸ªçº¿ç¨‹é€€å‡º
- å‡½æ•°åŸå‹ï¼š  
  `void pthread_exit(void *retval);` 
- å‡½æ•°å‚æ•°ï¼š
  - `retval` è¡¨ç¤ºçº¿ç¨‹é€€å‡ºçŠ¶æ€ï¼Œé€šå¸¸ä¼ NULL


ã€:o:ã€‘`pthread_exit` æˆ– `return` è¿”å›çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜å•å…ƒå¿…é¡»æ˜¯å…¨å±€çš„æˆ–è€…æ˜¯mallocåˆ†é…çš„ï¼Œä¸èƒ½å†çº¿ç¨‹å‡½æ•°çš„æ ˆä¸Šåˆ†é…  
             å› ä¸ºå½“å…¶å®ƒçº¿ç¨‹å¾—åˆ°è¿™ä¸ªè¿”å›æŒ‡é’ˆæ—¶çº¿ç¨‹å‡½æ•°å·²ç»é€€å‡ºäº†ï¼Œæ ˆç©ºé—´å°±ä¼šè¢«å›æ”¶

```C
  1 //pthread_exitæµ‹è¯•ï¼šä¸»çº¿ç¨‹é€€å‡ºï¼Œå­çº¿ç¨‹ä¸ºé€€å‡º
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 void *threadfunc(void *arg)
 10 {
 11     printf("child thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 12     sleep(100);
 13 }
 14 
 15 int main()
 16 {
 17     //
 18     pthread_t thread;
 19     int ret = pthread_create(&thread, NULL, threadfunc, NULL);
 20     if (ret!=0)
 21     {
 22         printf("pthread_create error, [%s]\n", strerror(ret));
 23         return -1;
 24     }
 25     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 26 
 27     pthread_exit(NULL);
 28     sleep(1);
 29     return 0;
 30 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ ps ajx | grep pthread_exit
  8760  13816  13816   8760 pts/0     13816 Zl+   1000   0:00 [pthread_exit] <defunct>
 [xfk@centos PTHREAD]$ ps -Lf 13816
 UID         PID   PPID    LWP  C NLWP STIME TTY      STAT   TIME CMD
 xfk       13816   8760  13816  0    2 23:12 pts/0    Zl+    0:00 [pthread_exit] <defunct>
 xfk       13816   8760  13817  0    2 23:12 pts/0    Sl+    0:00 [pthread_exit] <defunct>
```

ã€:football:ã€‘ä¸»çº¿ç¨‹é€€å‡ºå˜æˆåƒµå°¸è¿›ç¨‹æ˜¯ç”±äºè¿˜æœªå›æ”¶  
			 è§£å†³åŠæ³•ï¼š`pthread_join` 

#### pthread_joinå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šé˜»å¡ç­‰å¾…çº¿ç¨‹é€€å‡ºï¼Œè·å–çº¿ç¨‹é€€å‡ºçŠ¶æ€ï¼ˆå¯¹åº”è¿›ç¨‹ä¸­çš„ `waitpid`ï¼‰
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_join(pthread_t thread, void **retval);` 
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
- å‡½æ•°å‚æ•°ï¼š
  - `thread` çº¿ç¨‹ID
  - `retval` å­˜å‚¨çº¿ç¨‹ç»“æŸçŠ¶æ€ï¼Œæ•´ä¸ªæŒ‡é’ˆå’Œ `pthread_exit` çš„å‚æ•°æ˜¯åŒä¸€å—å†…å­˜åœ°å€


```C
  1 //pthread_joinæµ‹è¯•ï¼šå›æ”¶å­çº¿ç¨‹
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 int g_var = 10;		//çº¿ç¨‹ç»“æŸçŠ¶æ€ï¼ˆå¯ä»¥æ˜¯ä»»ä½•æ•°æ®ç±»å‹ï¼‰
 10 
 11 void *threadfunc(void *arg)
 12 {
 13     printf("child thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 14     printf("[%p]\n", &g_var);
 15     pthread_exit(&g_var);
 16 }
 17 
 18 int main()
 19 {
 20     //åˆ›å»ºå­çº¿ç¨‹
 21     pthread_t thread;
 22     int ret = pthread_create(&thread, NULL, threadfunc, NULL);
 23     if (ret!=0)
 24     {
 25         printf("pthread_create error, [%s]\n", strerror(ret));
 26         return -1;
 27     }
 28     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 29 
 30     //å›æ”¶å­çº¿ç¨‹
 31     void *p = NULL;
 32     pthread_join(thread, &p);
 33     printf("child exit status:[%d],[%p]\n", *(int *)p, p);
 34 
 35     return 0;
 36 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ ./pthread_join 
 main thread, pid==[14372], id==[140440773224256]
 child thread, pid==[14372], id==[140440764892928]
 [0x60105c]
 child exit status:[10],[0x60105c]
```

#### pthread_detachå‡½æ•°

çº¿ç¨‹åˆ†ç¦»çŠ¶æ€ï¼šæŒ‡å®šè¯¥çŠ¶æ€ï¼Œçº¿ç¨‹ä¸»åŠ¨ä¸ä¸»æ§çº¿ç¨‹æ–­å¼€å…³ç³»  
çº¿ç¨‹ç»“æŸåï¼Œå…¶é€€å‡ºçŠ¶æ€ä¸ç”±å…¶å®ƒçº¿ç¨‹è·å–ï¼Œè€Œç›´æ¥è‡ªå·±è‡ªåŠ¨é‡Šæ”¾ï¼ˆç½‘ç»œã€å¤šçº¿ç¨‹æœåŠ¡å™¨å¸¸ç”¨ï¼‰

ã€:ticket:ã€‘`pthread_create` å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°å¯è®¾ç½®çº¿ç¨‹åˆ†ç¦»  
             `pthread_detach` å‡½æ•°æ˜¯åœ¨åˆ›å»ºçº¿ç¨‹ä¹‹åè°ƒç”¨çš„

- å‡½æ•°ä½œç”¨ï¼šå®ç°çº¿ç¨‹åˆ†ç¦»
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_detach(pthread_t thread);` 
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
- å‡½æ•°å‚æ•°ï¼š`thread` çº¿ç¨‹ID

```C
  1 //pthread_detachæµ‹è¯•
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 void *threadfunc(void *arg)
 10 {
 11     printf("child thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 12 }
 13 
 14 int main()
 15 {
 16     //åˆ›å»ºå­çº¿ç¨‹
 17     pthread_t thread;
 18     int ret = pthread_create(&thread, NULL, threadfunc, NULL);
 19     if (ret!=0)
 20     {
 21         printf("pthread_create error, [%s]\n", strerror(ret));
 22         return -1;
 23     }
 24     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 25 
 26     //è®¾ç½®çº¿ç¨‹åˆ†ç¦»
 27     pthread_detach(thread);
 28     //å­çº¿ç¨‹åˆ†ç¦»çŠ¶æ€åˆ™pthread_joinä¸å†é˜»å¡ï¼Œç«‹å³è¿”å› 
 29     ret = pthread_join(thread, NULL);
 30     if (ret!=0)
 31     {
 32         printf("pthread_join error:[%s]\n", strerror(ret));
 33     }
 34 
 35     sleep(1);
 36     return 0;
 37 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ ./pthread_detach 
 main thread, pid==[14984], id==[140373116782400]
 pthread_join error:[Invalid argument]
 child thread, pid==[14984], id==[140373108451072]
```

#### pthread_cancelå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šæ€æ­»å–æ¶ˆçº¿ç¨‹ï¼ˆå¯¹åº”è¿›ç¨‹ä¸­çš„ `kill`ï¼‰
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_cancel(pthread_t thread);` 
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
- å‡½æ•°å‚æ•°ï¼š`thread` çº¿ç¨‹ID

ã€:hourglass_flowing_sand:ã€‘çº¿ç¨‹çš„å–æ¶ˆå¹¶ä¸æ˜¯å®æ—¶çš„ï¼Œè€Œæœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œéœ€è¦çº¿ç¨‹åˆ°è¾¾æŸä¸ªå–æ¶ˆç‚¹ï¼ˆæ£€æŸ¥ç‚¹ï¼‰  
            å–æ¶ˆç‚¹ï¼šæ˜¯çº¿ç¨‹æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆï¼Œå¹¶æŒ‰è¯·æ±‚è¿›è¡ŒåŠ¨ä½œçš„ä¸€ä¸ªä½ç½®ï¼Œé€šå¸¸ä¸€äº›ç³»ç»Ÿè°ƒç”¨å…·å¤‡å–æ¶ˆç‚¹ ï¼ˆ `man 7 pthreads` å¯æŸ¥çœ‹ï¼‰  
            è®¾ç½®å–æ¶ˆç‚¹ï¼š  `void pthread_testcancel(void);` 

```C
  1 //pthread_cancelæµ‹è¯•
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 void *threadfunc(void *arg)
 10 {
 11     while(1)
 12     {
 13         pthread_testcancel();		//è®¾ç½®å–æ¶ˆç‚¹
 14     }
 15 }
 16 
 17 int main()
 18 {
 19     //åˆ›å»ºå­çº¿ç¨‹
 20     pthread_t thread;
 21     int ret = pthread_create(&thread, NULL, threadfunc, NULL);
 22     if (ret!=0)
 23     {
 24         printf("pthread_create error, [%s]\n", strerror(ret));
 25         return -1;
 26     }
 27     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 28 
 29     //å–æ¶ˆå­çº¿ç¨‹
 30     pthread_cancel(thread);
 31     ret = pthread_join(thread, NULL);
 32     if(ret==0)
 33     {
 34         printf("child cancel\n");
 35     }
 36 
 37     return 0;
 38 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ ./pthread_cancel 
 main thread, pid==[15923], id==[139871012722496]
 child cancel
```

#### pthread_equalå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šæ¯”è¾ƒä¸¤ä¸ªçº¿ç¨‹IDæ˜¯å¦ç›¸ç­‰
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_equal(pthread_t t1, pthread_t t2);` 
- å‡½æ•°è¿”å›å€¼ï¼š
  - ç›¸ç­‰ï¼šé 0 å€¼
  - ä¸ç›¸ç­‰ï¼š0

- å‡½æ•°å‚æ•°ï¼š`t1` `t2` æ¯”è¾ƒçš„çº¿ç¨‹ID

ã€:triangular_flag_on_post:ã€‘æ‰©å±•ä½¿ç”¨ï¼š`pthread_t` ç±»å‹å¯èƒ½åœ¨æœªæ¥å˜åŒ–ï¼ˆæ¯”å¦‚ç»“æ„ä½“ï¼‰ï¼Œä¸ºæ­¤æä¾›æ¥å£

```C
  1 //pthread_equalæµ‹è¯•
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 void *threadfunc(void *arg)
 10 {
 11     printf("child thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 12 }
 13 
 14 int main()
 15 {
 16     //åˆ›å»ºå­çº¿ç¨‹
 17     pthread_t thread;
 18     int ret = pthread_create(&thread, NULL, threadfunc, NULL);
 19     if (ret!=0)
 20     {
 21         printf("pthread_create error, [%s]\n", strerror(ret));
 22         return -1;
 23     }
 24     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 25 
 26     sleep(1);
 27     //æ¯”è¾ƒçº¿ç¨‹ID
 28     if(pthread_equal(pthread_self(), thread)!=0)
 29     {
 30         printf("SAME\n");
 31     }
 32     else
 33     {
 34         printf("NOT SAME\n");
 35     }
 36 
 37     return 0;
 38 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ ./pthread_equal 
 main thread, pid==[16315], id==[140453167179584]
 child thread, pid==[16315], id==[140453158848256]
 NOT SAME
```

### 2.5 çº¿ç¨‹å±æ€§

**è®¾ç½®çº¿ç¨‹å±æ€§ï¼š** >>>ï¼ˆ`pthread_create` ç¬¬äºŒä¸ªå‚æ•°ï¼‰

<font color=CornflowerBlue>**ç¬¬ä¸€æ­¥ï¼šå®šä¹‰çº¿ç¨‹å±æ€§ç±»å‹å˜é‡**</font>  
				`pthread_attr_t attr` 

<font color=CornflowerBlue>**ç¬¬äºŒæ­¥ï¼šå¯¹çº¿ç¨‹å±æ€§å˜é‡è¿›è¡Œåˆå§‹åŒ–**</font>  
                `int pthread_attr_init(pthread_attr_t *attr);` 

<font color=CornflowerBlue>**ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®çº¿ç¨‹ä¸ºåˆ†ç¦»å±æ€§**</font>  
                `int pthread_attr_setdetachstate(pthread_attr_t *attr, int detachstate);`   
                å‚æ•°ï¼š`attr` çº¿ç¨‹å±æ€§  
                            `detachstate` ï¼šåˆ†ç¦» `PTHREAD_CREATE_DETACHED` / éåˆ†ç¦» `PTHREAD_CREATE_JOINABLE` 

<font color=CornflowerBlue>**ç¬¬å››æ­¥ï¼šé‡Šæ”¾çº¿ç¨‹å±æ€§èµ„æº**</font>  
                `int pthread_attr_destroy(pthread_attr_t *attr);` 

```C
  1 //è®¾ç½®çº¿ç¨‹åˆ†ç¦»å±æ€§
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 void *threadfunc(void *arg)
 10 {
 11     printf("child thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 12 }
 13 
 14 int main()
 15 {
 16     //å®šä¹‰çº¿ç¨‹å±æ€§ç±»å‹å˜é‡
 17     pthread_attr_t attr;
 18     //å¯¹çº¿ç¨‹å±æ€§å˜é‡è¿›è¡Œåˆå§‹åŒ–
 19     pthread_attr_init(&attr);
 20     //è®¾ç½®çº¿ç¨‹ä¸ºåˆ†ç¦»å±æ€§
 21     pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
 22 
 23     //åˆ›å»ºå­çº¿ç¨‹
 24     pthread_t thread;
 25     int ret = pthread_create(&thread, &attr, threadfunc, NULL);
 26     if (ret!=0)
 27     {
 28         printf("pthread_create error, [%s]\n", strerror(ret));
 29         return -1;
 30     }
 31     printf("main thread, pid==[%d], id==[%ld]\n", getpid(), pthread_self());
 32 
 33     //é‡Šæ”¾çº¿ç¨‹å±æ€§èµ„æº
 34     pthread_attr_destroy(&attr);
 35     //å­çº¿ç¨‹åˆ†ç¦»çŠ¶æ€åˆ™pthread_joinä¸å†é˜»å¡ï¼Œç«‹å³è¿”å›
 36     ret = pthread_join(thread, NULL);
 37     if (ret!=0)
 38     {
 39         printf("pthread_join error:[%s]\n", strerror(ret));
 40     }
 41 
 42     sleep(1);
 43     return 0;
 44 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos PTHREAD]$ ./pthread_attr 
 main thread, pid==[9505], id==[139874090227520]
 pthread_join error:[Invalid argument]
 child thread, pid==[9505], id==[139874081896192]
```

## 3. çº¿ç¨‹åŒæ­¥:satellite: 

**çº¿ç¨‹åŒæ­¥ï¼ŒæŒ‡ä¸€ä¸ªçº¿ç¨‹å‘å‡ºæŸä¸€åŠŸèƒ½è°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨ä¸è¿”å›ã€‚åŒæ—¶å…¶å®ƒçº¿ç¨‹ä¸ºä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä¸èƒ½è°ƒç”¨è¯¥åŠŸèƒ½ã€‚** 

ã€:pill: **TEST**ã€‘ ä¸¤ä¸ªçº¿ç¨‹è®¡æ•°ï¼Œå…±äº«åŒä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåˆ†åˆ«è®¡æ•°5000  
                        **RESULT** >>> **10000**:question: 

 ```C
   1 //æµ‹è¯•ä¸¤ä¸ªçº¿ç¨‹è®¡æ•°ï¼Œå…±äº«åŒä¸€ä¸ªå…¨å±€å˜é‡
   2 #include <stdio.h>
   3 #include <stdlib.h>
   4 #include <string.h>
   5 #include <sys/types.h>
   6 #include <unistd.h>
   7 #include <pthread.h>
   8 
   9 #define NUM 5000
  10 
  11 int num = 0;
  12 
  13 void *threadfunc1(void *arg)
  14 {
  15     int i = 0;
  16     int n;
  17     for(i=0;i<NUM;i++)
  18     {
  19         n = num;
  20         n++;
  21         num = n;
  22     }
  23 }
  24 
  25 void *threadfunc2(void *arg)
  26 {
  27     int i = 0;
  28     int n;
  29     for(i=0;i<NUM;i++)
  30     {
  31         n = num;
  32         n++;
  33         num = n;
  34     }
  35 }
  36 
  37 int main()
  38 {
  39     
  40     pthread_t thread1;
  41     int ret = pthread_create(&thread1, NULL, threadfunc1, NULL);
  42     if (ret!=0)
  43     {
  44         printf("pthread_create error, [%s]\n", strerror(ret));
  45         return -1;
  46     }
  47 
  48     pthread_t thread2;
  49     ret = pthread_create(&thread2, NULL, threadfunc2, NULL);
  50     if (ret!=0)
  51     {
  52         printf("pthread_create error, [%s]\n", strerror(ret));
  53         return -1;
  54     }
  55 
  56     pthread_join(thread1, NULL);
  57     pthread_join(thread2, NULL);
  58 
  59     printf("num==[%d]\n", num);
  60 
  61     return 0;
  62 }
 
  >>>>æ‰§è¡Œç»“æœï¼ˆå¯èƒ½å‡ºç°å°‘æ•°çš„ç°è±¡ï¼‰
  [xfk@centos PTHREAD]$ ./pthread_lock 
  num==[9996]
 ```

ã€:beetle:ã€‘èµ„æºå…±äº«  
             éšæœºè°ƒåº¦ï¼ˆçº¿ç¨‹æŒ‰cpuæ—¶é—´ç‰‡è¿è¡Œï¼Œçº¿ç¨‹ä¹‹é—´æ¥å›åˆ‡æ¢ï¼‰  
             çº¿ç¨‹é—´ç¼ºä¹å¿…è¦çš„åŒæ­¥æœºåˆ¶

ã€:closed_lock_with_key:ã€‘**äº’æ–¥é”**ï¼šçº¿ç¨‹Aå’Œçº¿ç¨‹Bå…±åŒè®¿é—®å…±äº«èµ„æºï¼Œå½“çº¿ç¨‹Aæƒ³è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ï¼Œè¦å…ˆè·å¾—é”  
             å¦‚æœé”è¢«å ç”¨ï¼Œåˆ™é˜»å¡ç­‰å¾…  
			 å¦‚æœé”æœªè¢«å ç”¨ï¼Œåˆ™åŠ é”æ“ä½œå…±äº«èµ„æº

### 3.1 äº’æ–¥é”ç›¸å…³å‡½æ•°

```C
#include <pthread.h>
```

ã€:shopping_cart:ã€‘`pthread_mutex_t` ç±»å‹ï¼ˆstructï¼‰  
             `pthread_mutex_t mutex;` è¯¥å˜é‡åªæœ‰ä¸¤ç§å–å€¼1/0

#### pthread_mutex_initå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šåˆå§‹åŒ–ä¸€ä¸ªäº’æ–¥é”ï¼ˆåˆå€¼å¯çœ‹ä½œ1ï¼‰
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_mutex_init(pthread_mutex_t *restrict mutex, const pthread_mutexattr_t *restrict attr);`  
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
- å‡½æ•°å‚æ•°ï¼š
  - `mutex` ä¼ å‡ºå‚æ•°
  - `attr` äº’æ–¥é”å±æ€§ï¼Œé€šå¸¸ä¼ NULLï¼Œé»˜è®¤å±æ€§ï¼ˆçº¿ç¨‹é—´å…±äº«ï¼‰

ã€:key:ã€‘**restrict å…³é”®å­—**   
             åªç”¨äºé™åˆ¶æŒ‡é’ˆï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæ‰€æœ‰ä¿®æ”¹è¯¥æŒ‡é’ˆæŒ‡å‘å†…å­˜ä¸­å†…å®¹çš„æ“ä½œï¼Œåªèƒ½é€šè¿‡è¯¥æŒ‡é’ˆå®Œæˆ

ã€:heavy_plus_sign:ã€‘`mutex` å˜é‡çš„åˆå§‹åŒ–æ–¹å¼  
             é™æ€åˆå§‹åŒ–ï¼ˆå…¨å±€æˆ–staticä¿®é¥°ï¼‰ï¼š`pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;`   
             åŠ¨æ€åˆå§‹åŒ–ï¼ˆå±€éƒ¨ï¼‰ï¼š`pthread_mutex_init(&mutex, NULL);` 

#### pthread_mutex_destroyå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šé”€æ¯ä¸€ä¸ªäº’æ–¥é”
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_mutex_destroy(pthread_mutex_t *mutex);`  
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·

- å‡½æ•°å‚æ•°ï¼š`mutex` äº’æ–¥é”å˜é‡


#### pthread_mutex_lockå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šå¯¹äº’æ–¥é”åŠ é”ï¼Œå¯ç†è§£ä¸º `mutex--` 
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_mutex_lock(pthread_mutex_t *mutex);`  
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
- å‡½æ•°å‚æ•°ï¼š`mutex` äº’æ–¥é”å˜é‡

#### pthread_mutex_unlockå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šå¯¹äº’æ–¥é”è§£é”ï¼Œå¯ç†è§£ä¸º `mutex++` 
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_mutex_unlock(pthread_mutex_t *mutex);` 
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·

- å‡½æ•°å‚æ•°ï¼š`mutex` äº’æ–¥é”å˜é‡


#### pthread_mutex_trylockå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šå°è¯•åŠ é”
- å‡½æ•°åŸå‹ï¼š  
  `int pthread_mutex_trylock(pthread_mutex_t *mutex);`  
- å‡½æ•°è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
- å‡½æ•°å‚æ•°ï¼š`mutex` äº’æ–¥é”å˜é‡

### 3.2 äº’æ–¥é”ï¼šåŠ é”/è§£é”

ã€:ticket:ã€‘äº’æ–¥é”ä½¿ç”¨æ­¥éª¤  
             1.å®šä¹‰äº’æ–¥é”å˜é‡ `pthread_mutex_t mutex;`  
		     2.åœ¨mainå‡½æ•°ä¸­åˆå§‹åŒ–äº’æ–¥é” `pthread_mutex_init(&mutex, NULL);`  
    	     3.åœ¨å…±äº«èµ„æºæ“ä½œä¸Šä¸‹åŠ é”/è§£é”   
		         	`pthread_mutex_lock(&mutex);` 
                  	//å…±äº«èµ„æºæ“ä½œä»£ç //  
                 	`pthread_mutex_unlock(&mutex);`  
        	 4.åœ¨mainå‡½æ•°ä¸­é”€æ¯äº’æ–¥é” `pthread_mutex_destroy(&mutex);` 

```C
  1 //äº’æ–¥é”æµ‹è¯•
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <pthread.h>
  8 
  9 #define NUM 5000
 10 
 11 int num = 0;
 12 
 13 //å®šä¹‰äº’æ–¥é”å˜é‡
 14 pthread_mutex_t mutex;
 15 
 16 void *threadfunc1(void *arg)
 17 {
 18     int i = 0;
 19     int n;
 20     for(i=0;i<NUM;i++)
 21     {
 22         //åŠ é”
 23         pthread_mutex_lock(&mutex);
 24         n = num;
 25         n++;
 26         num = n;
 27         //è§£é”
 28         pthread_mutex_unlock(&mutex);
 29     }
 30 }
 31 
 32 void *threadfunc2(void *arg)
 33 {
 34     int i = 0;
 35     int n;
 36     for(i=0;i<NUM;i++)
 37     {
 38         pthread_mutex_lock(&mutex);
 39         n = num;
 40         n++;
 41         num = n;
 42         pthread_mutex_unlock(&mutex);
 43     }
 44 }
 45 
 46 int main()
 47 {
 48     //åˆå§‹åŒ–äº’æ–¥é”
 49     pthread_mutex_init(&mutex, NULL);
 50 
 51     pthread_t thread1;
 52     int ret = pthread_create(&thread1, NULL, threadfunc1, NULL);
 53     if (ret!=0)
 54     {
 55         printf("pthread_create error, [%s]\n", strerror(ret));
 56         return -1;
 57     }
 58 
 59     pthread_t thread2;
 60     ret = pthread_create(&thread2, NULL, threadfunc2, NULL);
 61     if (ret!=0)
 62     {
 63         printf("pthread_create error, [%s]\n", strerror(ret));
 64         return -1;
 65     }
 66 
 67     pthread_join(thread1, NULL);
 68     pthread_join(thread2, NULL);
 69 
 70     //é”€æ¯äº’æ–¥é”
 71     pthread_mutex_destroy(&mutex);
 72 
 73     printf("num==[%d]\n", num);
 74 
 75     return 0;
 76 }

 >>>>æ‰§è¡Œç»“æœï¼ˆä¸ä¼šå‡ºé”™ï¼Œä½†æ‰§è¡Œæ•ˆç‡å˜ä½ï¼‰
 [xfk@centos PTHREAD]$ ./pthread_lock 
 num==[10000]
```

ã€:atm:ã€‘åŸå­æ“ä½œï¼šè¯¥æ“ä½œè¦ä¹ˆä¸æ‰§è¡Œï¼Œè¦ä¹ˆå°±å®Œæˆï¼ˆäº’æ–¥é”æ˜¯åŸå­æ“ä½œçš„æ¨¡æ‹Ÿï¼‰

---
> âœï¸ [é‚¢ç¦å‡¯ (xfkcode@github)](https://github.com/xfkcode)  
> ğŸ“… **å†™äº2023å¹´1æœˆ**  