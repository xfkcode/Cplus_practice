# è¿›ç¨‹ç®¡ç†

## 1. è¿›ç¨‹ç›¸å…³æ¦‚å¿µ

### 1.1 ç¨‹åºå’Œè¿›ç¨‹

- ç¨‹åºï¼Œæ˜¯æŒ‡ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ç£ç›˜ä¸Šï¼Œå ç”¨ç£ç›˜ç©ºé—´ï¼Œæ˜¯ä¸€ä¸ªé™æ€çš„æ¦‚å¿µ
- è¿›ç¨‹ï¼Œä¸€ä¸ªå¯åŠ¨çš„ç¨‹åºï¼Œè¿›ç¨‹å ç”¨çš„æ˜¯ç³»ç»Ÿèµ„æºï¼Œå¦‚ï¼šç‰©ç†å†…å­˜ï¼ŒCUPï¼Œç»ˆç«¯ç­‰ï¼Œæ˜¯ä¸€ä¸ªåŠ¨æ€çš„æ¦‚å¿µ

ã€:ticket:ã€‘ç¨‹åº $\rightarrow$ å‰§æœ¬ï¼Œè¿›ç¨‹ $\rightarrow$ æˆ  
             åŒä¸€ä¸ªå‰§æœ¬å¯ä»¥åœ¨å¤šä¸ªèˆå°åŒæ—¶ä¸Šæ¼”ã€‚åŒæ ·ï¼ŒåŒä¸€ä¸ªç¨‹åºä¹Ÿå¯ä»¥åŠ è½½ä¸ºä¸åŒçš„è¿›ç¨‹ï¼ˆå½¼æ­¤ä¹‹é—´äº’ä¸å½±å“ï¼‰  
             æ¯å¯åŠ¨ä¸€ä¸ªç¨‹åºå°±ä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹PIDï¼Œå³ä½¿æ˜¯ç›¸åŒçš„ç¨‹åºå¤šæ¬¡å¯åŠ¨ä¹Ÿä¼šæœ‰ä¸åŒçš„PID

### 1.2 å¹¶å‘å’Œå¹¶è¡Œ 

- å¹¶å‘ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œæ˜¯åœ¨åŒä¸€ä¸ªcpuä¸Šï¼ŒåŒæ—¶è¿è¡Œå¤šä¸ªç¨‹åº
- å¹¶è¡Œï¼Œåœ¨ä¸€ä¸ªæ—¶é—´ç‰‡å†…ï¼Œæœ‰å¤šä¸ªç¨‹åºåœ¨æ‰§è¡Œï¼ˆå¤šæ ¸cpuï¼‰

ã€:loudspeaker:ã€‘cupå°†ä¸€ä¸ªå¤§çš„æ—¶é—´æ®µåˆ†æˆå¤šä¸ªå°çš„æ—¶é—´ç‰‡ï¼Œè®©è¿›ç¨‹è½®æµä½¿ç”¨cpuçš„æ—¶é—´ç‰‡

### 1.3 PCBè¿›ç¨‹æ§åˆ¶å—

æ¯ä¸ªè¿›ç¨‹åœ¨å†…æ ¸ä¸­éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æ§åˆ¶å—ï¼ˆPCBï¼‰æ¥ç»´æŠ¤è¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼ŒLinuxå†…æ ¸çš„è¿›ç¨‹æ§åˆ¶å—æ˜¯ `task_struct` ç»“æ„ä½“

- è¿›ç¨‹idï¼Œç³»ç»Ÿä¸­æ¯ä¸ªè¿›ç¨‹æœ‰å”¯ä¸€çš„idï¼Œåœ¨Cè¯­è¨€ä¸­ç”¨ `pid_t` ç±»å‹è¡¨ç¤ºï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°
- è¿›ç¨‹çš„çŠ¶æ€ï¼Œæœ‰å°±ç»ªã€è¿è¡Œã€æŒ‚èµ·ã€ç»ˆæ­¢ç­‰çŠ¶æ€
- è¿›ç¨‹åˆ‡æ¢æ—¶éœ€è¦ä¿å­˜å’Œæ¢å¤çš„ä¸€äº›cpuå¯„å­˜å™¨
- æè¿°è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¿¡æ¯
- æè¿°æ§åˆ¶ç»ˆç«¯çš„ä¿¡æ¯
- å½“å‰å·¥ä½œç›®å½•  
  `getcwd` è·å–å½“å‰å·¥ä½œç›®å½•
- `umask` æ©ç 
- æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼ŒåŒ…å«å¾ˆå¤šæŒ‡å‘ file ç»“æ„ä½“çš„æŒ‡é’ˆ
- å’Œä¿¡å·ç›¸å…³çš„ä¿¡æ¯
- ç”¨æˆ· id å’Œç»„ id
- ä¼šè¯å’Œè¿›ç¨‹ç»„
- è¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„èµ„æºä¸Šé™  
  `ulimit -a` æŸ¥çœ‹èµ„æºä¸Šé™

### 1.4 è¿›ç¨‹çŠ¶æ€

- è¿è¡Œï¼Œè¿›ç¨‹è·å¾—cpuæ—¶é—´ç‰‡ï¼Œæœ‰æ‰§è¡Œèµ„æ ¼ï¼Œåœ¨cpuæ—¶é—´ç‰‡ç”¨å®Œåè¿›å…¥å°±ç»ªçŠ¶æ€

- å°±ç»ªï¼Œè¿›ç¨‹æœ‰æ‰§è¡Œèµ„æ ¼ï¼Œä½†æ²¡æœ‰æˆ–å¾—cpuæ—¶é—´ç‰‡ï¼Œåœ¨è·å¾—cpuæ—¶é—´ç‰‡åè¿›å…¥è¿è¡ŒçŠ¶æ€

- æŒ‚èµ·ï¼Œè¿›ç¨‹æ²¡æœ‰æ‰§è¡Œèµ„æ ¼ï¼Œä¸èƒ½è·å–cpuæ—¶é—´ç‰‡ï¼ˆå°±ç»ªã€è¿è¡Œå‡å¯ç›´æ¥è½¬æŒ‚èµ·ï¼‰  
  ä»æŒ‚èµ·çŠ¶æ€ä¸èƒ½ç›´æ¥å›åˆ°è¿è¡Œæ€ï¼Œå¿…é¡»å…ˆå›åˆ°å°±ç»ªçŠ¶æ€ï¼Œå†è¿›å…¥è¿è¡ŒçŠ¶æ€

- ç»ˆæ­¢ï¼Œè¿›ç¨‹ç»“æŸï¼ˆå°±ç»ªã€è¿è¡Œã€æŒ‚èµ·å‡å¯ç›´æ¥è½¬ç»ˆæ­¢ï¼‰

## 2. åˆ›å»ºè¿›ç¨‹

### 2.1 forkå‡½æ•°

- å‡½æ•°ä½œç”¨ï¼šåˆ›å»ºå­è¿›ç¨‹

- åŸå‹ï¼š  
  `pid_t fork(void);` 

- è¿”å›å€¼ï¼š

  - çˆ¶è¿›ç¨‹è¿”å›çš„æ˜¯å­è¿›ç¨‹çš„PIDï¼Œè¿™ä¸ªå€¼å¤§äº 0ï¼›
  - å­è¿›ç¨‹è¿”å›çš„æ˜¯ 0 ï¼›

  æ³¨æ„:warning: ï¼šå¹¶ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹è¿”å›ä¸¤ä¸ªå€¼ï¼Œè€Œæ˜¯ç”±çˆ¶å­è¿›ç¨‹å„è‡ªè¿”å›ä¸€ä¸ªå€¼

- çˆ¶å­è¿›ç¨‹çš„æ‰§è¡Œé€»è¾‘ï¼š  
  çˆ¶è¿›ç¨‹æ‰§è¡Œ `pid>0` çš„é€»è¾‘ï¼Œå­è¿›ç¨‹æ‰§è¡Œ `pid==0` çš„é€»è¾‘

- çˆ¶å­è¿›ç¨‹æ‰§è¡Œå…ˆåï¼š  
  è°å…ˆæŠ¢åˆ°cpuæ—¶é—´ç‰‡è°å…ˆæ‰§è¡Œ

ã€:loudspeaker:ã€‘çˆ¶è¿›ç¨‹è°ƒç”¨forkå‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹çš„ç”¨æˆ·åŒºå’Œçˆ¶è¿›ç¨‹çš„ç”¨æˆ·åŒºå®Œå…¨ä¸€æ ·ï¼Œä½†æ˜¯å†…æ ¸åŒºä¸å®Œå…¨ä¸€æ ·ï¼Œå¦‚çˆ¶è¿›ç¨‹çš„PIDå’Œå­è¿›ç¨‹çš„PIDä¸ä¸€æ ·

ã€:loudspeaker: ã€‘çˆ¶å­è¿›ç¨‹å…¨å±€å˜é‡ï¼ˆæ— æ³•å®ç°é€šä¿¡ï¼‰  
              å†™æ—¶å¤åˆ¶ï¼Œå‰¯æœ¬ä¿®æ”¹ï¼›è¯»æ—¶å…±äº«ã€‚

```C
  1 //forkå‡½æ•°æµ‹è¯•
  2 #include<stdio.h>
  3 #include<stdlib.h>
  4 #include<string.h>
  5 #include<sys/types.h>
  6 #include<sys/stat.h>
  7 #include<unistd.h>
  8 #include<fcntl.h>
  9 
 10 int main(int argc, char *argv[])
 11 {
 12     printf("before fork, pid:[%d]\n",getpid());
 13     //åˆ›å»ºå­è¿›ç¨‹
 14     //pid_t fork(void);
 15     pid_t pid = fork();
 16     if (pid<0)          //åˆ›å»ºå¤±è´¥
 17     {
 18         perror("fork error");
 19         return -1;
 20     }
 21     else if (pid>0)     //çˆ¶è¿›ç¨‹
 22     {
 23         printf("father: pid=[%d]\n",getpid());
 24         //sleep (1);
 25     }
 26     else if (pid==0)    //å­è¿›ç¨‹
 27     {
 28         printf("child: pid=[%d]\n",getpid());
 29         //sleep (1);
 30     }
 31 
 32     printf("after fork, pid:[%d]\n",getpid());
 33     return 0;
 34 }

 >>>>æ‰§è¡Œç»“æœ1ï¼Œå­è¿›ç¨‹å…ˆé€€å‡º
 before fork, pid:[117039]
 father: pid=[117039], fpid=[8096]
 child: pid=[117040], fpid=[117039]
 after fork, pid:[117039]
 after fork, pid:[117040]
 >>>>æ‰§è¡Œç»“æœ2ï¼Œçˆ¶è¿›ç¨‹å…ˆé€€å‡º
 before fork, pid:[128429]
 father: pid=[128429], fpid=[8096]
 after fork, pid:[128429]
 [xfk@centos FORKFUNC]$ child: pid=[128430], fpid=[1]  //1è¿›ç¨‹æˆä¸ºçˆ¶è¿›ç¨‹
 after fork, pid:[128430]
 //çˆ¶è¿›ç¨‹é€€å‡ºè¿”å›shellï¼Œä½†æ²¡æœ‰çœŸæ­£å…³é—­ç»ˆç«¯ï¼Œå› ä¸ºå­è¿›ç¨‹è¿˜æ²¡æœ‰é€€å‡ºï¼ˆçˆ¶å­è¿›ç¨‹å…±äº«åŒä¸€ä¸ªç»ˆç«¯ï¼‰
```

#### å¾ªç¯åˆ›å»ºå­è¿›ç¨‹

ã€:ticket:ã€‘æ¯æ¬¡åˆ›å»ºçš„å­è¿›ç¨‹æ•° `2^i`   
             ä¸€å…±åˆ›å»ºå­è¿›ç¨‹ä¸ªæ•° `2^n-1`  
             æ€»è¿›ç¨‹æ•° `2^n`  

æ³¨æ„:warning:ï¼š`i` å¾ªç¯å˜é‡ï¼ˆ0å¼€å§‹ï¼‰ï¼Œ`n` å¾ªç¯æ¬¡æ•°

ã€:recycle:ã€‘`i=0` åˆ›å»º1ä¸ªå­è¿›ç¨‹  
             `i=1` åˆ›å»º2ä¸ªå­è¿›ç¨‹  
             `i=2` åˆ›å»º4ä¸ªå­è¿›ç¨‹  
             ... ...

```C
  1 //å¾ªç¯åˆ›å»ºå­è¿›ç¨‹
  2 #include<stdio.h>
  3 #include<stdlib.h>
  4 #include<string.h>
  5 #include<sys/types.h>
  6 #include<sys/stat.h>
  7 #include<unistd.h>
  8 #include<fcntl.h>
  9 
 10 int main(int argc, char *argv[])
 11 {
 12     int i=0;
 13     for(i=0;i<3;i++)
 14     {
 15         //åˆ›å»ºå­è¿›ç¨‹
 16         //pid_t fork(void);
 17         pid_t pid = fork();
 18         if (pid<0)          //åˆ›å»ºå¤±è´¥
 19         {
 20             perror("fork error");
 21             return -1;
 22         }
 23         else if (pid>0)     //çˆ¶è¿›ç¨‹
 24         {
 25             printf("father: pid=[%d], fpid=[%d]\n", getpid(), getppid());
 26         }
 27         else if (pid==0)    //å­è¿›ç¨‹
 28         {
 29             printf("child: pid=[%d], fpid=[%d]\n", getpid(), getppid());
 30         }
 31     }
 32     sleep(10);
 33     return 0;
 34 }

 >>>>æ‰§è¡Œç»“æœ
 father: pid=[46993], fpid=[8096]
 father: pid=[46993], fpid=[8096]
 father: pid=[46993], fpid=[8096]
 child: pid=[46995], fpid=[46993]
 father: pid=[46995], fpid=[46993]
 child: pid=[46996], fpid=[46993]
 child: pid=[46994], fpid=[46993]
 father: pid=[46994], fpid=[46993]
 father: pid=[46994], fpid=[46993]
 child: pid=[46997], fpid=[46995]
 child: pid=[46998], fpid=[46994]
 father: pid=[46998], fpid=[46994]
 child: pid=[46999], fpid=[46994]
 child: pid=[47000], fpid=[46998]
 //ä¸€å…±åˆ›å»º7ä¸ªå­è¿›ç¨‹
```

ã€:lock: ã€‘`break;` é˜»æ­¢å­è¿›ç¨‹åœ¨å¾ªç¯ä¸­ç»§ç»­åˆ›å»ºå­è¿›ç¨‹

```C
 1 //å¾ªç¯åˆ›å»º3ä¸ªå…„å¼Ÿå­è¿›ç¨‹
  2 #include<stdio.h>
  3 #include<stdlib.h>
  4 #include<string.h>
  5 #include<sys/types.h>
  6 #include<sys/stat.h>
  7 #include<unistd.h>
  8 #include<fcntl.h>
  9 
 10 int main(int argc, char *argv[])
 11 {
 12     int i=0;
 13     for(i=0;i<3;i++)
 14     {
 15         //åˆ›å»ºå­è¿›ç¨‹
 16         //pid_t fork(void);
 17         pid_t pid = fork();
 18         if (pid<0)          //åˆ›å»ºå¤±è´¥
 19         {
 20             perror("fork error");
 21             return -1;
 22         }
 23         else if (pid>0)     //çˆ¶è¿›ç¨‹
 24         {
 25             printf("father: pid=[%d], fpid=[%d]\n", getpid(), getppid());
 26         }
 27         else if (pid==0)    //å­è¿›ç¨‹
 28         {
 29             printf("child: pid=[%d], fpid=[%d]\n", getpid(), getppid());
 30             break;			//é˜»æ­¢é€’å½’åˆ›å»ºå­è¿›ç¨‹
 31         }
 32     }
 33     if (i==0)               //ç¬¬1ä¸ªå­è¿›ç¨‹
 34     {
 35         printf("[%d]--[%d]:child\n",i,getpid());
 36     }
 37     if (i==1)               //ç¬¬2ä¸ªå­è¿›ç¨‹
 38     {
 39         printf("[%d]--[%d]:child\n",i,getpid());
 40     }
 41     if (i==2)               //ç¬¬3ä¸ªå­è¿›ç¨‹
 42     {
 43         printf("[%d]--[%d]:child\n",i,getpid());
 44     }
 45     if (i==3)               //çˆ¶è¿›ç¨‹
 46     {
 47         printf("[%d]--[%d]:child\n",i,getpid());
 48     }
 49     sleep(10);
 50     return 0;
 51 }

>>>>æ‰§è¡Œç»“æœ
father: pid=[123588], fpid=[8096]
father: pid=[123588], fpid=[8096]
father: pid=[123588], fpid=[8096]
[3]--[123588]:child
child: pid=[123589], fpid=[123588]
[0]--[123589]:child
child: pid=[123590], fpid=[123588]
[1]--[123590]:child
child: pid=[123591], fpid=[123588]
[2]--[123591]:child
```



---
> âœï¸ [é‚¢ç¦å‡¯ (xfkcode@github)](https://github.com/xfkcode)  
> ğŸ“… **å†™äº2023å¹´1æœˆ** 