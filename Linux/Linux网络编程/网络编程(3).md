# ç½‘ç»œç¼–ç¨‹(3):shirt: 

## 1. åŠå…³é—­:satellite: 

å¦‚æœä¸€æ–¹closeï¼Œå¦ä¸€æ–¹æ²¡æœ‰closeï¼Œåˆ™è®¤ä¸ºæ˜¯åŠå…³é—­çŠ¶æ€  
å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå¯ä»¥æ¥å—æ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½å‘é€æ•°æ®

ã€:postbox:ã€‘åŠå…³é—­ä¸€å®šå‡ºç°åœ¨ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹

#### shutdownå‡½æ•°

```C
#include <sys/socket.h>
int shutdown(int sockfd, int how);
```

- å‡½æ•°è¯´æ˜ï¼šå…³é—­å…¨éƒ¨æˆ–éƒ¨åˆ†å…¨åŒå·¥é“¾æ¥
- å‚æ•°è¯´æ˜ï¼š
  - `sockfd` ï¼šæ–‡ä»¶æè¿°ç¬¦
  - `how` ï¼š
    - SHUT_RDï¼šè¯»ï¼ˆæ¥æ”¶ï¼‰ç¦æ­¢
    - SHUT_WRï¼š å†™ï¼ˆå‘é€ï¼‰ç¦æ­¢
    - SHUT_RDWRï¼š è¯»å†™ç¦æ­¢
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0 
  - å¤±è´¥ï¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® `errno` 

ã€:shopping_cart:ã€‘shutdownå’Œcloseçš„åŒºåˆ«  
             1.shutdownå¯å®ç°åŠå…³é—­ï¼Œcloseä¸å¯ä»¥  
		     2.shutdownä¸è€ƒè™‘æ–‡ä»¶æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°ï¼Œç›´æ¥å…³é—­  
			    closeè€ƒè™‘æ–‡ä»¶æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°ï¼Œåªæœ‰å‡å°åˆ°0æ‰è¢«çœŸæ­£å…³é—­

ã€:atm:ã€‘é•¿è¿æ¥&çŸ­è¿æ¥  
		    é•¿è¿æ¥ï¼šè¿æ¥å»ºç«‹å¥½ä¹‹åï¼Œä¸€ç›´ä¿æŒè¿æ¥ä¸å…³é—­  
		    çŸ­è¿æ¥ï¼šè¿æ¥ä½¿ç”¨å®Œä¹‹åç«‹åˆ»å…³é—­

## 2. å¿ƒè·³åŒ…:heart_decoration: 

æ£€æŸ¥ä¸å¯¹æ–¹çš„ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸  
è¿æ¥å¼‚å¸¸å…ˆå…³é—­åé‡å»º  
ä¸€èˆ¬ç”¨äºé•¿è¿æ¥

ã€:construction:ã€‘æ–¹æ³•1  
			 ä¸èƒ½å®æ—¶æ£€æµ‹ç½‘ç»œæƒ…å†µ

```C
keepAlive = 1;
setsockopt(lfd, SOL_SOCKET, SO_KEEPALIVE, (void*)&keepAlive, sizeof(keepAlive));
```

ã€:blue_heart:ã€‘æ–¹æ³•2  
 è‡ªå®šä¹‰åè®®ï¼š `4Byteæ•°æ®é•¿åº¦ + æ•°æ®éƒ¨åˆ†`   
			  Aç«¯å‘é€ >>> `0000+AAAA`    
			  Bç«¯å›å¤ >>> `0000+BBBB`    
 è‹¥Aç«¯å¤šæ¬¡å‘é€Bç«¯ä¸å›å¤åˆ™è¿æ¥å¼‚å¸¸ï¼š  
	          å…ˆå…³é—­åŸè¿æ¥  
	          å†é‡å»ºæ–°è¿æ¥

## 3. é«˜å¹¶å‘æœåŠ¡å™¨:shopping_cart: 

å¤šè·¯IOæŠ€æœ¯ï¼šselectï¼ŒåŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå°†ç›‘æ§çš„æ“ä½œäº¤ç»™å†…æ ¸å»å¤„ç†

#### selectå‡½æ•°

```C
#include <sys/time.h>
#include <sys/types.h>
#include <unistd.h>
int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);
```

- å‡½æ•°æè¿°ï¼šå§”æ‰˜å†…æ ¸ç›‘æ§å¯è¯»ï¼Œå¯å†™ï¼Œå¼‚å¸¸äº‹ä»¶
- å‚æ•°è¯´æ˜ï¼š
  - `nfds` ï¼šå†…æ ¸ç›‘æ§æ–‡ä»¶æè¿°èŒƒå›´ï¼Œä¸€èˆ¬å–å€¼æœ€å¤§æ–‡ä»¶æè¿°ç¬¦+1
  - `readfds` ï¼š
    - è¾“å…¥ï¼šå†…æ ¸ç›‘æ§å“ªäº›æ–‡ä»¶æè¿°ç¬¦
    - è¾“å‡ºï¼šå“ªäº›æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–
  - `writefds` ï¼š
    - è¾“å…¥ï¼šå†…æ ¸ç›‘æ§å“ªäº›æ–‡ä»¶æè¿°ç¬¦
    - è¾“å‡ºï¼šå“ªäº›æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–
  - `exceptfds` ï¼šè¾“å…¥è¾“å‡ºå‚æ•°ï¼Œä¸€èˆ¬è¡¨ç¤ºå¼‚å¸¸äº‹ä»¶
  - `timeout` ï¼šè¶…æ—¶æ—¶é—´
    - `NULL`ï¼šè¡¨ç¤ºæ°¸ä¹…é˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿ
    - `0`ï¼šè¡¨ç¤ºä¸é˜»å¡ï¼Œä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶å‘ç”Ÿ
    - `>0`ï¼šè¡¨ç¤ºé˜»å¡æ—¶é•¿  
                è‹¥æ²¡æœ‰è¶…è¿‡æ—¶é•¿ï¼Œåˆ™ä¸€ç›´é˜»å¡  
                è‹¥åœ¨æ—¶é•¿å†…æœ‰äº‹ä»¶å‘ç”Ÿï¼Œåˆ™ç«‹åˆ»è¿”å›  
                è‹¥è¶…è¿‡æ—¶é•¿ï¼Œåˆ™ç«‹åˆ»è¿”å›
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å›å‘ç”Ÿå˜åŒ–æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡
  - é”™è¯¯ï¼š-1ï¼Œå¹¶è®¾ç½® `errno` 

```C
void FD_CLR(int fd, fd_set *set);		//ä»seté›†åˆä¸­æ¸…é™¤fdæ–‡ä»¶æè¿°ç¬¦
int  FD_ISSET(int fd, fd_set *set);		//åˆ¤æ–­fdæ˜¯å¦åœ¨seté›†åˆä¸­
void FD_SET(int fd, fd_set *set);		//å°†fdæ·»åŠ åˆ°seté›†åˆä¸­
void FD_ZERO(fd_set *set);				//æ¸…ç©ºæ–‡ä»¶æè¿°ç¬¦é›†
```

ã€:beetle:ã€‘æµç¨‹

```C
1	åˆ›å»ºsocket
2	ç«¯å£å¤ç”¨setsockopt
3	ç»‘å®šbind  
4	ç›‘å¬listen 
5	fd_set readfds;			//å®šä¹‰æ–‡ä»¶æè¿°ç¬¦é›†åˆ
	fd_set tmpfds;			//å®šä¹‰ä¸´æ—¶(ç›‘æ§è¿”å›)æ–‡ä»¶æè¿°ç¬¦é›†åˆ
	FD_ZERO(&readfds);		//æ¸…ç©ºæ–‡ä»¶æè¿°ç¬¦é›†åˆ
	FD_ZERO(&tmpfds);		//æ¸…ç©ºä¸´æ—¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ
	FD_SET(lfd, &readfds);	//å°†lfdåŠ å…¥æ–‡ä»¶æè¿°ç¬¦é›†åˆ
	maxfd = lfd;
	while(1){
        tmpfds = readfds;
        nready = select(maxfd+1, &tmpfds, NULL ,NULL, NULL);
        if(nready<0){											//selectå¼‚å¸¸
            if(errno==EINTR) continue;							//è¢«ä¿¡å·ä¸­æ–­
            break;
        }
        
        //å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚åˆ°è¾¾
        if(FD_ISSET(lfd, &tmpfds)){
            //æ¥æ”¶æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚
            cfd = accept(lfd, NULL, NULL);
            FD_SET(cfd, &readfds);
            if(maxfd<cfd) maxfd = cfd;							//ä¿®æ”¹å†…æ ¸ç›‘æ§æ–‡ä»¶æè¿°ç¬¦çš„èŒƒå›´
            if(--nready==0) continue;							//è¯¥å˜åŒ–å¤„ç†å®Œè‹¥å†æ— å…¶ä»–åˆ™è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯
        }
        
        //å®¢æˆ·ç«¯æ•°æ®åˆ°è¾¾
        for(i=lfd+1;i<=maxfd;i++){
            if(FD_ISSET(i, &tmpfds)){
            	//readæ•°æ®
               	n = read(i, buf, sizeof(buf));
                if(n<=0){										//readå¼‚å¸¸
                    close(i);
                    FD_CLR(i, &readfds);
                }
                else{
                    //writeæ•°æ®
                	write(i, buf, n); 
               	}
                if(--nready==0) continue;
            }
    	}
    }
    close(lfd);
6	ä¼˜åŒ–ï¼šåˆ›å»ºä¸€ä¸ªè®°å½•é€šä¿¡æ–‡ä»¶æè¿°ç¬¦çš„æ•°ç»„ï¼Œä½¿ç”¨ä¸€ä¸ªå˜é‡è®°å½•æ•°ç»„ä¸­æœ€å¤§å…ƒç´ çš„ä¸‹æ ‡
    	 æ— æ•ˆæ–‡ä»¶æè¿°ç¬¦ç›´æ¥è·³è¿‡
    int maxi;
    int client[1024];
	//åˆå§‹åŒ–
    for(i=0;i<FD_SETSIZE;i++){
        client[i] = -1;
    }
	//æ·»åŠ æ–°è¿æ¥æ–‡ä»¶æè¿°ç¬¦ï¼ˆåœ¨æ–°å»ºè¿æ¥åï¼‰
	for(i=0;i<FD_SETSIZE;i++){
        if(client[i]==-1){
            client[i] = cfd;
            break;
        }
    }
	if(i==FD_SETSIZE){
        close(cfd);
        print("too many clients, i==[%d]\n", i);
    }
	if(i>maxi){
        maxi = i;
    }
	//å®¢æˆ·ç«¯æ•°æ®åˆ°è¾¾,åªéœ€å¾ªç¯clientæ•°ç»„ä¸­æœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦
	for(i=0;i<maxi;i++){}
```

ã€:pill:**TEST**ã€‘

```C
  1 //selectå¹¶å‘æœåŠ¡å™¨æµ‹è¯•
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/time.h>
  6 #include <sys/types.h>
  7 #include <unistd.h>
  8 #include <sys/socket.h>
  9 #include <arpa/inet.h>
 10 #include <ctype.h>
 11 #include <errno.h>
 12 #include <sys/select.h>
 13 
 14 int main()
 15 {
 16     //åˆ›å»ºsocket
 17     int lfd = socket(AF_INET, SOCK_STREAM, 0);
 18     if(lfd<0)
 19     {
 20         perror("socket error");
 21         return -1;
 22     }
 23 
 24     //ç«¯å£å¤ç”¨
 25     int opt = 1;
 26     setsockopt(lfd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(int));
 27 
 28     //ç»‘å®š
 29     struct sockaddr_in serv;
 30     bzero(&serv, sizeof(serv));
 31     serv.sin_family = AF_INET;
 32     serv.sin_port = htons(8888);
 33     serv.sin_addr.s_addr = htonl(INADDR_ANY);
 34     int ret = bind(lfd, (struct sockaddr*)&serv, sizeof(serv));
 35     if(ret<0)
 36     {
 37         perror("bind error");
 38         return -1;
 39     }    
 40 
 41     //ç›‘å¬
 42     listen(lfd, 128); 
 43 
 44     fd_set readfds;					//å®šä¹‰æ–‡ä»¶æè¿°ç¬¦é›†åˆ
 45     fd_set tmpfds;					//å®šä¹‰ä¸´æ—¶(ç›‘æ§è¿”å›)æ–‡ä»¶æè¿°ç¬¦é›†åˆ
 46     FD_ZERO(&readfds);				//æ¸…ç©ºæ–‡ä»¶æè¿°ç¬¦é›†åˆ
 47     FD_ZERO(&tmpfds);				//æ¸…ç©ºä¸´æ—¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ
 48     FD_SET(lfd, &readfds);			//å°†lfdåŠ å…¥æ–‡ä»¶æè¿°ç¬¦é›†åˆ
 49 
 50     int maxfd = lfd;
 51     int nready;
 52     int cfd;
 53     int i;
 54     int j;
 55     int n;
 56     char buf[1024];
 57 
 58     while(1)
 59     {
 60         tmpfds = readfds;
 61         nready = select(maxfd+1, &tmpfds, NULL ,NULL, NULL);
 62         if(nready<0)
 63         {
 64             if(errno==EINTR) continue;
 65         }
 66         break;
 67 
 68         //å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚åˆ°è¾¾
 69         if(FD_ISSET(lfd, &tmpfds))
 70         {
 71             cfd = accept(lfd, NULL, NULL);
 72             FD_SET(cfd, &readfds);
 73             if(maxfd<cfd) maxfd = cfd;						//ä¿®æ”¹å†…æ ¸ç›‘æ§æ–‡ä»¶æè¿°ç¬¦çš„èŒƒå›´
 74             if(--nready==0) continue;						//è¯¥å˜åŒ–å¤„ç†å®Œè‹¥å†æ— å…¶ä»–åˆ™è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯
 75         }
 76 
 77         //å®¢æˆ·ç«¯æ•°æ®åˆ°è¾¾
 78         for(i=lfd+1;i<=maxfd;i++)
 79         {
 80             if(FD_ISSET(i, &tmpfds))
 81             {
 82                 memset(buf, 0x00, sizeof(buf));
 83                 //readæ•°æ®
 84                 n = read(i, buf, sizeof(buf));
 85                 if(n<=0)
 86                 {
 87                     close(i);
 88                     FD_CLR(i, &readfds);
 89                 }
 90                 else
 91                 {
 92                     printf("n==[%d],buf==[%s]\n", n, buf);
 93                     for(j=0;j<n;j++)
 94                     {
 95                         buf[j] = toupper(buf[j]);
 96                     }
 97                     //writeæ•°æ®
 98                     write(cfd, buf, n);
 99                 }
100                 if(--nready==0) continue;
101             }
102         }
103     }
104     close(lfd);
105     return 0;
106 }

```

ã€:atm:ã€‘ä¼˜ç¼ºç‚¹  
			ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯  
			selectæ”¯æŒè·¨å¹³å°  
		    ä»£ç ç¼–å†™ç›¸è¾ƒå›°éš¾  
		    æ¶‰åŠç”¨æˆ·åŒºåˆ°å†…æ ¸åŒºçš„æ¥å›æ‹·è´  
			å½“å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œä½†å°‘æ•°æ´»è·ƒï¼Œselectæ•ˆç‡è¾ƒä½  
			æœ€å¤§æ”¯æŒFD_SETSIZE=1024ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼‰

---
> âœï¸ [é‚¢ç¦å‡¯ (xfkcode@github)](https://github.com/xfkcode)  
> ğŸ“… **å†™äº2023å¹´2æœˆ** 
