# ç½‘ç»œç¼–ç¨‹(6)

## libevent

### åœ°åŸºevent_base

ä½¿ç”¨ libevent å‡½æ•°ä¹‹å‰éœ€è¦åˆ†é…ä¸€ä¸ªæˆ–å¤šä¸ª event_base ç»“æ„ä½“ï¼Œevent_base ç»“æ„ä½“ç›¸å½“äº epoll çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹   
æ¯ä¸ª event_baes ç»“æ„ä½“æŒæœ‰ä¸€ä¸ªäº‹ä»¶é›†åˆï¼Œå¯ä»¥æ£€æµ‹ä»¥ç¡®å®šå“ªä¸ªäº‹ä»¶æ˜¯æ¿€æ´»çš„  
æ¯ä¸ª event_base éƒ½æœ‰ä¸€ç§ç”¨äºæ£€æµ‹æŸç§äº‹ä»¶å·²ç»å°±ç»ªçš„â€œæ–¹æ³•â€ï¼ˆå›è°ƒå‡½æ•°ï¼‰

```C
struct event_base *event_base_new(void);
```

- å‡½æ•°è¯´æ˜ï¼šè·å¾— event_base ç»“æ„ä½“æŒ‡é’ˆ
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› event_base ç»“æ„ä½“æŒ‡é’ˆ
  - å¤±è´¥ï¼šè¿”å›NULL
- å‚æ•°è¯´æ˜ï¼švoid

```C
void event_base_free(struct event_base *base);
```

- å‡½æ•°è¯´æ˜ï¼šé‡Šæ”¾ event_base ç»“æ„ä½“æŒ‡é’ˆ
- è¿”å›å€¼ï¼švoid
- å‚æ•°è¯´æ˜ï¼ševent_base ç»“æ„ä½“æŒ‡é’ˆ

```C
int event_reinit(struct event_base *base);
```

- å‡½æ•°è¯´æ˜ï¼š  
  å¦‚æœæœ‰å­è¿›ç¨‹ï¼Œä¸”å­è¿›ç¨‹ä¹Ÿè¦ä½¿ç”¨ baseï¼Œåˆ™å­è¿›ç¨‹éœ€è¦å¯¹ event_base é‡æ–°åˆå§‹åŒ–ï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨ event_reinit å‡½æ•°
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0
  - å¤±è´¥ï¼šè¿”å› -1
- å‚æ•°è¯´æ˜ï¼š
  - `base` ï¼šç”± event_base_new è¿”å›çš„ event_base ç»“æ„ä½“æŒ‡é’ˆ

ã€:printer:ã€‘æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ”¯æŒçš„libeventæ–¹æ³•  
		     æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„æ–¹æ³•

```C
  1 //æµ‹è¯•å½“å‰ç³»ç»Ÿæ”¯æŒçš„libeventæ–¹æ³•å’Œå½“å‰ä½¿ç”¨çš„æ–¹æ³•
  2 #include <stdio.h>
  3 #include <string.h>
  4 #include <stdlib.h>
  5 #include <event2/event.h>
  6 
  7 int main()
  8 {
  9     int i = 0;
 10     //å½“å‰ç³»ç»Ÿæ”¯æŒçš„libeventæ–¹æ³•
 11     const char **p = event_get_supported_methods();
 12     while(p[i]!=NULL){
 13         printf("[%s] ", p[i++]);
 14     }
 15     printf("\n");
 16 
 17     //è·å–åœ°åŸºèŠ‚ç‚¹
 18     struct event_base *base = event_base_new();
 19     if(base==NULL){
 20         printf("event_base_new error\n");
 21         return -1;
 22     }
 23 
 24     //å½“å‰ä½¿ç”¨çš„æ–¹æ³•
 25     const char *pp = event_base_get_method(base);
 26     printf("[%s]\n", pp);
 27 
 28     //é‡Šæ”¾åœ°åŸºèŠ‚ç‚¹
 29     event_base_free(base);
 30 
 31     return 0;
 32 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos LIBEVENT]$ gcc -o event event.c -levent
 [xfk@centos LIBEVENT]$ ./event
 [epoll] [poll] [select] 
 [epoll]
```

### å¾ªç¯ç­‰å¾…event_loop

```C
int event_base_loop(struct event_base *base, int flags);
```

- å‡½æ•°è¯´æ˜ï¼šè¿›å…¥å¾ªç¯ç­‰å¾…äº‹ä»¶
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› `0` 
  - é”™è¯¯ï¼šè¿”å› `-1`
  - `1` ï¼šæ²¡æœ‰äº‹ä»¶å‘ç”Ÿæˆ–æ¿€æ´»ï¼Œé€€å‡º
- å‚æ•°è¯´æ˜ï¼š
  - `base` ï¼šç”± event_base_new è¿”å›çš„ event_base ç»“æ„ä½“æŒ‡é’ˆ
  - `flags` ï¼š
    - `#define EVLOOP_ONCE 0x01`   
      æŒ‡è§¦å‘ä¸€æ¬¡ï¼Œå¦‚æœäº‹ä»¶æ²¡æœ‰è¢«è§¦å‘ï¼Œé˜»å¡ç­‰å¾…
    - `#define EVLOOP_NONBLOCK 0x02`   
      éé˜»å¡æ–¹å¼æ£€æµ‹äº‹ä»¶æ˜¯å¦è¢«è§¦å‘ï¼Œä¸ç®¡äº‹ä»¶è§¦å‘ä¸å¦ï¼Œéƒ½ä¼šç«‹å³è¿”å›

```C
int event_base_dispatch(struct event_base *base);
```

- å‡½æ•°è¯´æ˜ï¼šè¿›å…¥å¾ªç¯ç­‰å¾…äº‹ä»¶
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› `0` 
  - é”™è¯¯ï¼šè¿”å› `-1`
  - `1` ï¼šæ²¡æœ‰äº‹ä»¶å‘ç”Ÿæˆ–æ¿€æ´»ï¼Œé€€å‡º
- å‚æ•°è¯´æ˜ï¼š
  - `base` ï¼šç”± event_base_new è¿”å›çš„ event_base ç»“æ„ä½“æŒ‡é’ˆ

```C
struct timeval{
    long tv_sec;
    long tv_usec;
};
int event_base_loopexit(struct event_base *base, const struct timeval *tv);
int event_base_loopbreak(struct event_base *);
```

ã€:ticket:ã€‘ç»ˆæ­¢å¾ªç¯  
		     `event_base_loopexit` å¦‚æœäº‹ä»¶è§¦å‘ï¼Œå›è°ƒå‡½æ•°è¿˜æœªæ‰§è¡Œå®Œï¼Œåˆ™å›è°ƒå‡½æ•°æ‰§è¡Œç»“æŸåç»ˆæ­¢å¾ªç¯ï¼ˆå¦‚æœtvéNULLï¼Œåˆ™ç­‰å¾…è®¾ç½®çš„æ—¶é—´tvåç«‹å³ç»ˆæ­¢å¾ªç¯ï¼‰  
		     `event_base_loopbreak` ç«‹å³ç»ˆæ­¢å¾ªç¯



---
> âœï¸ [é‚¢ç¦å‡¯ (xfkcode@github)](https://github.com/xfkcode)  
> ğŸ“… **å†™äº2023å¹´2æœˆ** 