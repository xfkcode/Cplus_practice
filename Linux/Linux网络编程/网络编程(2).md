# ç½‘ç»œç¼–ç¨‹(2)

## 1. ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹

**TCPé¢å‘è¿æ¥çš„å®‰å…¨å¯é çš„ä¼ è¾“** 

ã€**å®¢æˆ·ç«¯client**ã€‘>>> `SYN:2000(0)          mss<1024>` >>>ã€**æœåŠ¡ç«¯server**ã€‘  
                              <<< `SYN:5000(0) ACK:2001 mss<1024>` <<<  
					          >>> `ACK:5001` >>>  
  **ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥**  
					          >>> `Seq:2001(20)` >>>  
                              <<< `Seq:5001(50) ACK:2021` <<<  
							  >>> `ACK:5051` >>>  
  **æ•°æ®ä¼ è¾“**  
                              <<< `FIN:5051(0) ACK:2021` <<<  
						      >>> `ACK:5052` >>>   
							  >>> `FIN:2021(0) ACK:5052` >>>  
							  <<< `ACK:2022` <<<  
  **å››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥**   

ã€:ticket:ã€‘SYN (è¯·æ±‚)ï¼šsynchronous  
                                   æœ¬èº«å 1ä½  
             ACK (ç¡®è®¤)ï¼šacknowledgement  
                                   ç¡®è®¤åºå· = å¯¹æ–¹å‘é€çš„å€¼ + æ•°æ®çš„é•¿åº¦   
             FIN  (ç»“æŸ)ï¼šfinish  
                                   æœ¬èº«å 1ä½

## 2. æ»‘åŠ¨çª—å£

ä¸»è¦ä½œç”¨ï¼šè¿›è¡Œæµé‡æ§åˆ¶  
å¦‚æœå‘é€ç«¯å‘é€çš„é€Ÿåº¦è¾ƒå¿«ï¼Œæ¥æ”¶ç«¯æ”¶åˆ°æ•°æ®åå¤„ç†çš„é€Ÿåº¦è¾ƒæ…¢ï¼Œè€Œæ¥å—ç¼“å†²åŒºçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå°±ä¼šå¯¼è‡´æ¥æ”¶ç¼“å†²åŒºæ»¡è€Œä¸¢å¤±æ•°æ®

`win 4096` æ¥æ”¶ç¼“å­˜åŒºå¯ç”¨å¤§å°ï¼ŒåŠ¨æ€å˜åŒ–ï¼Œå³æ»‘åŠ¨çª—å£  
                   æ¥æ”¶åˆ°æ•°æ®åçª—å£å‡å°ï¼Œçª—å£å‡å°è‡³ 0 æ—¶åœæ­¢æ¥æ”¶ï¼Œè¯»å–æ•°æ®åçª—å£æ‰©å¤§

`mss 1024` ä¸€æ¬¡æœ€å¤§æ¥æ”¶æ•°æ®é‡

## 3. å‡½æ•°å°è£…æ€æƒ³

```C
void perr_exit(const char *s)
{
    perror(s);
    exit(-1);
}

int Accept(int fd, struct sockaddr *sa, socklen_t *salenptr)
{
    int n;
again:
    if ((n=accept(fd, sa, salenptr))<0){
        if ((error == ECONNABORTED)||(error == EINTR))
            goto again;
        else
            perr_exit("accept error");
    }
    return n;
}

int Bind(int fd, const struct sockaddr *sa, socklen_t salen)
{
    int n;
    if ((n=bind(fd,sa,salen))<0)
        perr_exit("bind error");
    return n;
}

int Connect(int fd, const struct sockaddr *sa, socklen_t salen)
{
    int n;
    if ((n=connect(fd, sa, salen))<0)
        perr_exit("connect error");
    return n;
}

int Listen(int fd, int backlog)
{
    int n;
    if ((n=listen(fd, backlog))<0)
        perr_exit("listen error");
    return n;
}

int Socket(int family, int type, int protocol)
{
    int n;
    if ((n=socket(family, type, protocol))<0)
        perr_exit("socket error");
    return n;
}

ssize_t Read(int fd, void *ptr, size_t nbytes)
{
    ssize_t n;
again:
    if ((n=read(fd, ptr, nbytes))==-1){
        if (error == EINTR)
            goto again;
        else
            return -1;
    }
    return n;
}

ssize_t Write(int fd, void *ptr, size_t nbytes)
{
    ssize_t n;
again:
    if ((n=write(fd, ptr, nbytes))==-1){
        if (error == EINTR)
            goto again;
        else
            return -1;
    }
    return n;
}

int Close(int fd)
{
    int n;
    if ((n=close(fd))==-1)
        perr_exit("close error");
    return n;
}
```

ã€:warning:ã€‘é˜»å¡å‡½æ•°åœ¨é˜»å¡æœŸé—´è‹¥æ”¶åˆ°ä¿¡å·ï¼Œä¼šè¢«ä¿¡å·ä¸­æ–­ï¼Œ`errno` è®¾ç½®ä¸º` EINTR`  
             è¿™ä¸ªé”™è¯¯ä¸åº”è¯¥çœ‹æˆä¸€ä¸ªé”™è¯¯

## 4. ç²˜åŒ…

ç²˜åŒ…ï¼šå¤šæ¬¡æ•°æ®å‘é€ï¼Œä¸Šä¸€æ¬¡æœªè¯»å®Œï¼Œå‰©ä½™éƒ¨åˆ†ä¸ä¸‹ä¸€æ¬¡ç›¸è¿ï¼Œæ— æ³•åŒºåˆ†ä¸¤æ¬¡å‘é€æ•°æ®åˆ†åˆ«æ˜¯å¤šå°‘

- è§£å†³æ–¹æ¡ˆ1  
  åŒ…å¤´+æ•°æ® `0010+0123456789`   
  åŒ…å¤´4Byteè¡¨ç¤ºæ•°æ®é•¿åº¦
- è§£å†³æ–¹æ¡ˆ2  
  æ·»åŠ ç»“å°¾æ ‡è®°  
  å¦‚åœ¨ç»“å°¾åŠ ä¸€ä¸ªå­—ç¬¦ `\n` `\$` ç­‰ï¼ˆè‡ªå®šä¹‰åè®®ï¼‰
- è§£å†³æ–¹æ¡ˆ3  
  æ•°æ®åŒ…å®šé•¿

## 5. é«˜å¹¶å‘æœåŠ¡å™¨

#### å¤šè¿›ç¨‹

ã€:boxing_glove:ã€‘æµç¨‹  
            çˆ¶è¿›ç¨‹æ¥æ”¶æ–°çš„è¿æ¥å¹¶å›æ”¶å­è¿›ç¨‹  
            å­è¿›ç¨‹å¤„ç†æ–°çš„è¿æ¥ï¼ˆæ”¶å‘æ•°æ®ï¼‰

```C
1	åˆ›å»ºsocket  
2	ç»‘å®šbind  
3	ç›‘å¬listen  
4	while(1)
    {
    	//ç­‰å¾…æ–°çš„å®¢æˆ·ç«¯è¿æ¥
		cfd = accept();		//ä½¿ç”¨Accept()å°è£…å‡½æ•°å¿½ç•¥ä¿¡å·æ‰“æ–­
    	//fork
    	pid = fork();
    	if(pid<0)
        {
            exit(-1);
        }
    	else if(pid>0)		//çˆ¶è¿›ç¨‹
        {
            close(cfd);
            //SIGCHLD å›æ”¶å­è¿›ç¨‹
        }
    	else if(pid==0)		//å­è¿›ç¨‹
        {
            close(lfd);
            while(1)
            {
                //æ”¶å‘æ•°æ®
                n = read();	
                if(n<=0)
                    break;
                write();
            }
            close(cfd);
            exit(0);		//é˜²æ­¢å­è¿›ç¨‹å†åˆ›å»ºå­è¿›ç¨‹
        }
    }
	close(lfd);
```



#### å¤šçº¿ç¨‹

ã€:atm:ã€‘



---
> âœï¸ [é‚¢ç¦å‡¯ (xfkcode@github)](https://github.com/xfkcode)  
> ğŸ“… **å†™äº2023å¹´2æœˆ**  