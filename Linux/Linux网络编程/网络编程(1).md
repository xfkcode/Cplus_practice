# ç½‘ç»œç¼–ç¨‹(1):necktie: 

## 1. ç½‘ç»œåŸºç¡€æ¦‚å¿µ:dart: 

ã€:computer:ã€‘IPåœ°å€ç¡®å®šç½‘ç»œç¯å¢ƒä¸­å”¯ä¸€çš„ä¸€å°ä¸»æœº  
             ä¸»æœºä¸Šçš„ç«¯å£å·åŒºåˆ†ä¸åŒçš„åº”ç”¨ç¨‹åº

- [x] **IP+ç«¯å£ç¡®å®šä¸€å°ä¸»æœºä¸Šçš„ä¸€ä¸ªæœåŠ¡** 

### 1.1 åè®®

æ¦‚å¿µï¼šåè®®æŒ‡äº‹å…ˆçº¦å®šå¥½ï¼Œå¤§å®¶å…±åŒéµå®ˆçš„ä¸€ç»„è§„åˆ™ï¼Œå¦‚äº¤é€šä¿¡å·ç¯  
ä»åº”ç”¨ç¨‹åºçš„è§’åº¦çœ‹ï¼Œåè®®å¯ä»¥ç†è§£ä¸ºæ•°æ®ä¼ è¾“å’Œæ•°æ®è§£é‡Šçš„è§„åˆ™ï¼›  
å¯ä»¥ç®€å•çš„ç†è§£ä¸ºå„ä¸ªä¸»æœºä¹‹é—´è¿›è¡Œé€šä¿¡æ‰€ä½¿ç”¨çš„å…±åŒè¯­è¨€

ã€:open_file_folder:ã€‘æ–‡ä»¶ä¼ è¾“åè®®ï¼ˆ**ftpåè®®** åˆçº§ç‰ˆæœ¬ï¼‰  
		     Aæœºå™¨ $\rightarrow$ Bæœºå™¨  
			 1.æ–‡ä»¶å 2.æ–‡ä»¶å¤§å° 3.æ–‡ä»¶å†…å®¹  
			 Bæœºå™¨ $\rightarrow$ Aæœºå™¨  >>> OK

é‡‘å…¸åè®®

TCPåè®®ï¼Œä¼ è¾“æ§åˆ¶åè®®ï¼Œæ˜¯ä¸€ç§é¢å‘è¿æ¥çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„ä¼ è¾“å±‚é€šä¿¡åè®®  
UDPåè®®ï¼Œç”¨æˆ·æ•°æ®æŠ¥åè®®æ˜¯ï¼ŒOSIå‚è€ƒæ¨¡å‹ä¸­ä¸€ç§æ— çº¿è¿æ¥çš„ä¼ è¾“å±‚åè®®ï¼Œæä¾›é¢å‘äº‹åŠ¡çš„ç®€å•ä¸å¯é ä¿¡æ¯ä¼ é€æœåŠ¡  
HTTPåè®®ï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œæ˜¯äº’è”ç½‘ä¸Šåº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸€ç§ç½‘ç»œåè®®  
FTPåè®®ï¼Œæ–‡ä»¶ä¼ è¾“åè®®  
IPåè®®ï¼Œå› ç‰¹ç½‘äº’è”åè®®  
ICMPåè®®ï¼ŒInternetæ§åˆ¶æŠ¥æ–‡åè®®ï¼Œæ˜¯TCP/IPåè®®çš„æ—çš„ä¸€ä¸ªå­åè®®ï¼Œç”¨äºåœ¨IPä¸»æœºã€è·¯ç”±å™¨ä¹‹é—´ä¼ é€’æ§åˆ¶æ¶ˆæ¯  
IGMPåè®®ï¼ŒInternetç»„ç®¡ç†åè®®ï¼Œæ˜¯å› ç‰¹ç½‘åè®®å®¶æ—ä¸­çš„ä¸€ä¸ªç»„æ’­åè®®ã€‚è¯¥åè®®è¿è¡Œåœ¨ä¸»æœºå’Œç»„æ’­è·¯ç”±å™¨ä¹‹é—´  
ARPåè®®ï¼Œæ­£å‘åœ°å€è§£æåè®®ï¼Œé€šè¿‡å·²çŸ¥çš„IPï¼Œå¯»æ‰¾å¯¹åº”ä¸»æœºçš„MACåœ°å€  
RARPåè®®ï¼Œåå‘åœ°å€è½¬æ¢åè®®ï¼Œé€šè¿‡MACåœ°å€ç¡®å®šIPåœ°å€

### 1.2 åˆ†å±‚æ¨¡å‹

**OSI**ï¼ˆOpen System Interconnectionï¼‰ï¼Œå¼€æ”¾å¼ç³»ç»Ÿäº’è”  
å›½é™…æ ‡å‡†åŒ–ç»„ç»‡ï¼ˆISOï¼‰åˆ¶å®šäº†OSIæ¨¡å‹ï¼Œè¯¥æ¨¡å‹å®šä¹‰äº†ä¸åŒè®¡ç®—æœºäº’è”çš„æ ‡å‡†ï¼Œæ˜¯è®¾è®¡å’Œæè¿°è®¡ç®—æœºç½‘ç»œé€šä¿¡çš„åŸºæœ¬æ¡†æ¶

ã€:boxing_glove:ã€‘**OSI 7å±‚æ¨¡å‹**   
            ç‰©æ•°ç½‘ä¼ ä¼šè¡¨åº”

- ç‰©ç†å±‚---åŒç»çº¿ï¼Œå…‰çº¤ï¼Œå°†æ¨¡æ‹Ÿä¿¡å·è½¬æ¢ä¸ºæ•°å­—ä¿¡å·
- æ•°æ®é“¾è·¯å±‚---æ•°æ®æ ¡éªŒï¼Œå®šä¹‰äº†ç½‘ç»œä¼ è¾“çš„åŸºæœ¬å•ä½ã€å¸§ã€‘ï¼ˆARPåè®®ã€RARPåè®®ï¼‰
- ç½‘ç»œå±‚---å®šä¹‰ç½‘ç»œï¼Œä¸¤å°æœºå™¨ä¹‹é—´ä¼ è¾“çš„è·¯å¾„é€‰æ‹©ç‚¹åˆ°ç‚¹çš„ä¼ è¾“ï¼ˆIPåè®®ã€ICMPåè®®ã€IGMPåè®®ï¼‰
- ä¼ è¾“å±‚---ä¼ è¾“æ•°æ®ï¼Œç«¯åˆ°ç«¯çš„ä¼ è¾“ï¼ˆTCPåè®®ï¼ŒUDPåè®®ï¼‰
- ä¼šè¯å±‚---é€šè¿‡ä¼ è¾“å±‚å»ºç«‹æ•°æ®ä¼ è¾“çš„é€šé“ï¼Œå»ºç«‹ä¼šè¯ä¿æŒä¼šè¯
- è¡¨ç¤ºå±‚---ç¼–è§£ç ï¼Œç¿»è¯‘å·¥ä½œ
- åº”ç”¨å±‚---ä¸ºå®¢æˆ·æä¾›å„ç§åº”ç”¨æœåŠ¡ï¼ŒemailæœåŠ¡ï¼ŒftpæœåŠ¡ï¼ŒsshæœåŠ¡ï¼ˆhttpåè®®ï¼‰

ã€:ticket:ã€‘**TCP/IP 4å±‚æ¨¡å‹** 

- ç½‘ç»œæ¥å£å±‚>>>ã€ç‰©+æ•°ã€‘
- ç½‘ç»œå±‚
- ä¼ è¾“å±‚
- åº”ç”¨å±‚>>>ã€ä¼š+è¡¨+åº”ã€‘

**æ•°æ®é€šä¿¡è¿‡ç¨‹ï¼š**   
åœ¨å‘é€æ–¹æ˜¯æ•°æ®å±‚å±‚æ‰“åŒ…è¿‡ç¨‹ï¼Œåœ¨æ¥æ”¶æ–¹æ˜¯å±‚å±‚è§£åŒ…è¿‡ç¨‹  
TCP/IP æ¨¡å‹å±‚å±‚æ‰“åŒ…/è§£åŒ…

### 1.3 ç½‘ç»œåº”ç”¨ç¨‹åºè®¾è®¡æ¨¡å¼

- C/Sæ¨¡å¼  
  ä¼ ç»Ÿç½‘ç»œåº”ç”¨è®¾è®¡æ¨¡å¼ï¼Œå®¢æˆ·æœºï¼ˆclientï¼‰/æœåŠ¡å™¨ï¼ˆserverï¼‰æ¨¡å¼  
  éœ€è¦åœ¨é€šè®¯ä¸¤ç«¯å„è‡ªéƒ¨ç½²å®¢æˆ·æœºå’ŒæœåŠ¡å™¨æ¥å®Œæˆæ•°æ®é€šä¿¡
- B/Sæ¨¡å¼  
  æµè§ˆå™¨ï¼ˆbrowserï¼‰/æœåŠ¡å™¨ï¼ˆserverï¼‰æ¨¡å¼  
  åªéœ€è¦åœ¨ä¸€ç«¯éƒ¨ç½²æœåŠ¡å™¨ï¼Œè€Œå¦å¤–ä¸€ç«¯ä½¿ç”¨æ¯å°PCéƒ½é»˜è®¤é…ç½®çš„æµè§ˆå™¨å³å¯å®Œæˆæ•°æ®çš„ä¼ è¾“

### 1.4 ä»¥å¤ªç½‘å¸§æ ¼å¼

ä»¥å¤ªç½‘å¸§æ ¼å¼æ˜¯åŒ…è£…åœ¨ç½‘ç»œæ¥å£å±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰çš„åè®®

ã€ç›®çš„åœ°å€ï¼ˆMACåœ°å€ï¼‰6Byteã€‘+ã€æºåœ°å€ï¼ˆMACåœ°å€ï¼‰6Byteã€‘+ ã€ç±»å‹2Byteã€‘+ã€æ•°æ®46~1500Byteã€‘+ã€CRC4Byteã€‘

- ç±»å‹ 0800 ï¼šã€IPæ•°æ®æŠ¥46~1500Byteã€‘
- ç±»å‹ 0806 ï¼šã€ARPè¯·æ±‚/åº”ç­”28Byteã€‘+ã€PAD18Byteã€‘
- ç±»å‹ 0835 ï¼šã€RARPè¯·æ±‚/åº”ç­”28Byteã€‘+ã€PAD18Byteã€‘

ã€:printer:ã€‘ARPåè®®ï¼šåœ°å€è§£æåè®®ï¼Œé€šè¿‡ç›®çš„IPåœ°å€è·å–å…¶MACåœ°å€  
             RARPåè®®ï¼šé€†åœ°å€è§£æåè®®ï¼ŒMACåœ°å€ $\rightarrow$ IPåœ°å€  
			 TCPåè®®ï¼šé¢å‘è¿æ¥çš„ï¼Œå®‰å…¨çš„ï¼Œå¯é çš„æ•°æ®æµä¼ è¾“åè®®  
             UDPåè®®ï¼šé¢å‘æ— è¿æ¥çš„ï¼Œä¸å®‰å…¨çš„ï¼Œä¸å¯é çš„æ•°æ®æŠ¥ä¼ è¾“  

## 2. SOCKETç¼–ç¨‹:shopping_cart: 

ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡å€ŸåŠ©å†…æ ¸æä¾›çš„IPCæœºåˆ¶è¿›è¡Œï¼Œä½†æ˜¯åªèƒ½é™äºæœ¬æœºé€šä¿¡ï¼Œè‹¥è¦è·¨æœºé€šä¿¡ï¼Œå°±å¿…é¡»ä½¿ç”¨ç½‘ç»œé€šä¿¡  
æœ¬è´¨ä¸Šå€ŸåŠ©å†…æ ¸-å†…æ ¸æä¾›äº†socketä¼ªæ–‡ä»¶çš„æœºåˆ¶å®ç°é€šä¿¡ï¼Œå®é™…ä¸Šæ˜¯ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°å†…æ ¸æä¾›ç»™ç”¨æˆ·çš„ socket API åº“å‡½æ•°

### 2.1 socket ç¼–ç¨‹é¢„å¤‡çŸ¥è¯†

ç½‘ç»œå­—èŠ‚åº  
å¤§ç«¯å’Œå°ç«¯çš„æ¦‚å¿µ

- å¤§ç«¯ï¼šä½ä½åœ°å€å­˜æ”¾é«˜ä½æ•°æ®ï¼Œé«˜ä½åœ°å€å­˜æ”¾ä½ä½æ•°æ®
- å°ç«¯ï¼šä½ä½åœ°å€å­˜æ”¾ä½ä½æ•°æ®ï¼Œé«˜ä½åœ°å€å­˜æ”¾é«˜ä½æ•°æ®

```C
#include <stdio.h>
#include <stdlib.h>

union{
    short s;
    char c[sizeof(short)];
} un2;
union{
    int s;
    char c[sizeof(int)];
} un4;

int main()
{
    printf("[%d][%d][%d]\n", sizeof(short), sizeof(int), sizeof(long int));
    //æµ‹è¯•shortç±»å‹
    un2.s = 0x0102;
    printf("%d,%d,%d\n", un2.c[0], un2.c[1], un2.s);
    
    //æµ‹è¯•intç±»å‹
    un4.s = 0x01020304;
    printf("%d,%d,%d,%d,%d\n", un4.c[0], un4.c[1], un4.c[2], un4.c[3], un4.s);
    return 0;
}

>>>>æ‰§è¡Œç»“æœ
[xfk@centos SOCKET]$ ./endian
[2][4][8]
2,1,258
4,3,2,1,16909060
```

ã€:triangular_flag_on_post:ã€‘å¤§å°ç«¯è½¬æ¢å‡½æ•°  
			 ç½‘ç»œä¼ è¾“ç”¨çš„æ˜¯å¤§ç«¯ï¼Œå¦‚æœä¸»æœºç”¨çš„æ˜¯å°ç«¯ï¼Œåˆ™éœ€è¦è¿›è¡Œå¤§å°ç«¯è½¬æ¢

```C
#include <arpa/inet.h>
uint32_t htonl(unit32_t hostlong);
uint16_t htons(unit16_t hostshort);
uint32_t ntohl(unit32_t netlong);
uint16_t ntohs(unit16_t netshort);
```

  h>>>ä¸»æœºhostï¼Œn>>>ç½‘ç»œnetworkï¼Œs>>>shortï¼Œl>>>long

ã€:atm:ã€‘IPåœ°å€è½¬æ¢å‡½æ•°

```C
#include <arpa/inet.h>
int inet_pton(int af, const char *src, void *dst);
const char *inet_ntop(int af, const void *src, char *dst, socklen_t size);
```

  p>>>ç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œn>>>ç½‘ç»œnetwork

- å‡½æ•°1è¯´æ˜ï¼šå°†å­—ç¬¦ä¸²å½¢å¼çš„ç‚¹åˆ†åè¿›åˆ¶IPè½¬æ¢ä¸ºå¤§ç«¯æ¨¡å¼çš„ç½‘ç»œIP
- å‚æ•°è¯´æ˜ï¼š
  - `af` AF_INET / AF_INET6
  - `src` å­—ç¬¦ä¸²å½¢å¼çš„ç‚¹åˆ†åè¿›åˆ¶IPåœ°å€
  - `dst` å­˜æ”¾è½¬æ¢åçš„å˜é‡çš„åœ°å€

:recycle:è½¬æ¢åŸåˆ™ï¼š`192.168.232.145`   
                    è½¬åå…­è¿›åˆ¶ï¼š192>>>0xC0ï¼Œ168>>>0xA8ï¼Œ232>>>0xE8ï¼Œ145>>>0x91  
                     `0x91E8A8C0` 

- å‡½æ•°2è¯´æ˜ï¼šå°†å¤§ç«¯æ¨¡å¼çš„ç½‘ç»œIPè½¬æ¢ä¸ºå­—ç¬¦ä¸²å½¢å¼çš„ç‚¹åˆ†åè¿›åˆ¶IP
- å‚æ•°è¯´æ˜ï¼š
  - `af` AF_INET / AF_INET6
  - `src` å¤§ç«¯æ¨¡å¼çš„ç½‘ç»œIP
  - `dst` å­˜æ”¾è½¬æ¢åçš„å˜é‡çš„åœ°å€ï¼ˆä¸€èˆ¬ä¸ºå­—ç¬¦ä¸²æ•°ç»„ï¼‰
  - `size` dst çš„é•¿åº¦ï¼ˆ16ï¼‰
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å›æŒ‡å‘ dst çš„æŒ‡é’ˆ
  - å¤±è´¥ï¼šè¿”å›NULLï¼Œå¹¶è®¾ç½® `errno` 

:recycle:è½¬æ¢åŸåˆ™ï¼š`0x010AA8C0`   
                    è½¬åè¿›åˆ¶ï¼š0x01>>>1ï¼Œ0x0A>>>10ï¼Œ0xA8>>>168ï¼Œ0xC0>>>192  
                    `192.168.10.1` 

ã€:construction:ã€‘**struct sockaddr** 

```C
struct sockaddr{
    sa_family_t sa_family;
    char sa_data[14];
}

struct sockaddr_in {
    sa_family_t    sin_family; /* address family: AF_INET */
    in_port_t      sin_port;   /* port in network byte order */
	struct in_addr sin_addr;   /* internet address */
};

/* Internet address. */
struct in_addr {
	uint32_t       s_addr;     /* address in network byte order */
};
```

### 2.2 socket ç¼–ç¨‹ä¸»è¦ API å‡½æ•°ä»‹ç»

#### socketå‡½æ•°

```C
#include <sys/types.h>          
#include <sys/socket.h>
int socket(int domain, int type, int protocol);
```

- å‡½æ•°æè¿°ï¼šåˆ›å»ºsocket
- å‚æ•°è¯´æ˜ï¼š
  - `domain` åè®®ç‰ˆæœ¬  
    AF_INET---IPV4 / AF_INET6---IPV6 / AF_UNIX AF_LOCAL---æœ¬åœ°å¥—æ¥å­—
  - `type` åè®®ç±»å‹  
    SOCK_STREAM æµå¼ï¼Œé»˜è®¤ä½¿ç”¨TCPåè®®  
    SOCK_DGRAM  æŠ¥å¼ï¼Œé»˜è®¤ä½¿ç”¨UDPåè®®
  - `protocl` ä¸€èˆ¬ 0 ï¼Œè¡¨ç¤ºä½¿ç”¨å¯¹åº”ç±»å‹çš„é»˜è®¤åè®®
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å›ä¸€ä¸ªå¤§äº 0 çš„æ–‡ä»¶æè¿°ç¬¦
  - å¤±è´¥ï¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® `errno` 

ã€:label:ã€‘socketå‡½æ•°è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå†…æ ¸æä¾›ç›¸åº”çš„è¯»å†™ç¼“å†²åŒº  
             ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œè¯·æ±‚è¿æ¥é˜Ÿåˆ—å’Œå·²è¿æ¥é˜Ÿåˆ—

#### bindå‡½æ•°

```C
#include <sys/types.h>
#include <sys/socket.h>
int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);
```

- å‡½æ•°æè¿°ï¼šå°†socketæ–‡ä»¶æè¿°ç¬¦å’ŒIPï¼ŒPORTç»‘å®š
- å‚æ•°è¯´æ˜ï¼š
  - `socket` è°ƒç”¨socketå‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  - `addr` æœ¬åœ°æœåŠ¡å™¨çš„IPåœ°å€å’ŒPORT
  - `addrlen` addr å˜é‡å ç”¨çš„å†…å­˜å¤§å°
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0 
  - å¤±è´¥ï¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® `errno` 

```C
//addrè®¾ç½®
struct socketaddr_in serv;
serv.sin_family = AF_INET;
serv.sin_port = htons(8888);
serv.sin_addr.s_addr = htonl(INADDR_ANY);
//INADDR_ANY:è¡¨ç¤ºä½¿ç”¨æœ¬æœºä»»æ„æœ‰æ•ˆçš„å¯ç”¨IP
inet_pton(AF_INET, "172.0.0.1", &serv.sin_addr.s_addr);
```

#### listenå‡½æ•°

```C
#include <sys/types.h> 
#include <sys/socket.h>
int listen(int sockfd, int backlog);
```

- å‡½æ•°æè¿°ï¼šå°†å¥—æ¥å­—ç”±ä¸»åŠ¨æ€å˜ä¸ºè¢«åŠ¨æ€
- å‚æ•°è¯´æ˜ï¼š
  - `sockfd` è°ƒç”¨ socket å‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  - `backlog` åŒæ—¶è¯·æ±‚è¿æ¥çš„æœ€å¤§ä¸ªæ•°ï¼ˆè¿˜æœªå»ºç«‹è¿æ¥ï¼‰
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å› 0 
  - å¤±è´¥ï¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® `errno` 

#### acceptå‡½æ•°

```C
#include <sys/types.h>
#include <sys/socket.h>
int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);
```

- å‡½æ•°æè¿°ï¼šè·å¾—ä¸€ä¸ªè¿æ¥ï¼Œè‹¥å½“å‰æ²¡æœ‰è¿æ¥åˆ™ä¼šé˜»å¡ç­‰å¾…
- å‚æ•°è¯´æ˜ï¼š
  - `sockfd` è°ƒç”¨ socket å‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  - `addr` ä¼ å‡ºå‚æ•°ï¼Œä¿å­˜å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯
  - `addrlen` ä¼ å‡ºå‚æ•°ï¼Œaddr å˜é‡å ç”¨çš„å†…å­˜å¤§å°
- è¿”å›å€¼
  - æˆåŠŸï¼šè¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºå’Œå®¢æˆ·ç«¯é€šä¿¡
  - å¤±è´¥ï¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® `errno` 

#### connectå‡½æ•°

```C
#include <sys/types.h>          
#include <sys/socket.h>
int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);
```

- å‡½æ•°æè¿°ï¼šè¿æ¥æœåŠ¡å™¨
- å‚æ•°è¯´æ˜ï¼š
  - `sockfd` è°ƒç”¨ socket å‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  - `addr` æœåŠ¡ç«¯çš„åœ°å€ä¿¡æ¯
  - `addrlen` addr å˜é‡å ç”¨çš„å†…å­˜å¤§å°
- è¿”å›å€¼
  - æˆåŠŸï¼šè¿”å› 0 
  - å¤±è´¥ï¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® `errno` 

#### æ•°æ®è¯»å–å’Œå‘é€å‡½æ•°

```C
#include <unistd.h>
ssize_t read(int fd, void *buf, size_t count);
ssize_t write(int fd, const void *buf, size_t count);

#include <sys/types.h>
#include <sys/socket.h>
ssize_t recv(int sockfd, void *buf, size_t len, int flags);
ssize_t send(int sockfd, const void *buf, size_t len, int flags);
```

### 2.3 server/clientå¼€å‘æµç¨‹

ã€**æœåŠ¡ç«¯server**:computer:ã€‘ 

1. åˆ›å»º socket ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦lfd  
   `socket()` 
2. å°†lfdå’ŒIPã€PORTè¿›è¡Œç»‘å®š  
   `bind()` 
3. å°†lfdç”±ä¸»åŠ¨å˜ä¸ºè¢«åŠ¨ç›‘å¬  
   `listen()` 
4. æ¥æ”¶ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦  
   `accept()` 
5. while(1)  
   {  
           æ¥æ”¶æ¶ˆæ¯  `read/recv`   
           å‘é€æ•°æ®  `write/send`  
   }
6. å…³é—­æ–‡ä»¶æè¿°ç¬¦  
   `close(lfd)` `close(cfd)` 

```C
  1 //æœåŠ¡ç«¯å¼€å‘
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <sys/socket.h>
  8 #include <arpa/inet.h>
  9 #include <ctype.h>
 10 
 11 int main()
 12 {
 13     //åˆ›å»ºsocket
 14     int lfd = socket(AF_INET, SOCK_STREAM, 0);
 15     if(lfd<0)
 16     {
 17         perror("socket error");
 18         return -1;
 19     }
 20 
 21     //ç»‘å®šIPã€PORT
 22     struct sockaddr_in serv;
 23     bzero(&serv, sizeof(serv));
 24     serv.sin_family = AF_INET;
 25     serv.sin_port = htons(8888);
 26     serv.sin_addr.s_addr = htonl(INADDR_ANY);
 27     int ret = bind(lfd, (struct sockaddr*)&serv, sizeof(serv));
 28     if(ret<0)
 29     {
 30         perror("bind error");
 31         return -1;
 32     }
 33 
 34     //ç›‘å¬
 35     listen(lfd, 128);
 36 
 37     //æ¥æ”¶
 38     int cfd = accept(lfd, NULL, NULL);
 39     printf("lfd==[%d],cfd==[%d]\n", lfd, cfd);
 40 
 41     int i = 0;
 42     int n = 0;
 43     char buf[1024];
 44     while(1)
 45     {
 46         //æ¥æ”¶æ•°æ®
 47         memset(buf, 0x00, sizeof(buf));
 48         n = read(cfd, buf, sizeof(buf));
 49         if(n<=0)
 50         {
 51             printf("read error or client close, n==[%d]\n", n);
 52             break;
 53         }
 54         printf("n==[%d],buf==[%s]\n", n, buf);
 55 
 56         for(i=0;i<n;i++)
 57         {
 58             buf[i] = toupper(buf[i]);
 59         }
 60 
 61         //å‘é€æ•°æ®
 62         write(cfd, buf, n);
 63     }
 64 
 65     //å…³é—­æ–‡ä»¶æè¿°ç¬¦
 66     close(lfd);
 67     close(cfd);
 68 
 69     return 0;
 70 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos ~]$ nc 127.0.0.1 8888
 xfk   
 XFK
 ^C
 [xfk@centos SOCKET]$ ./server 
 lfd==[3],cfd==[4]
 n==[4],buf==[xfk
 ] 
 read error or client close, n==[0]
```

ã€:loudspeaker:ã€‘è°ƒç”¨acceptå‡½æ•°ä¸æ˜¯å»ºç«‹è¿æ¥ï¼Œè€Œæ˜¯ä»å·²è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå¯ç”¨è¿æ¥  
			 acceptå‡½æ•°åä¸¤ä¸ªå‚æ•°ä½¿ç”¨ï¼š

```C
//acceptè·å–å®¢æˆ·ç«¯IPã€PORTä¿¡æ¯
struct sockaddr_in client;
socklen_t len = sizeof(client);
int cfd = accept(lfd, (struct sockaddr*)&client, &len);
char sIP[16];
memset(sIP, 0x00, sizeof(sIP));
printf("client-->IP:[%s],PORT:[%d]\n", inet_ntop(AF_INET, &client.sin_addr.s_addr, sIP, sizeof(sIP)), ntohs(client.sin_port));
```

ã€**å®¢æˆ·ç«¯client**:iphone:ã€‘

1. åˆ›å»º socket ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦cfd  
   `socket()` 
2. è¿æ¥æœåŠ¡ç«¯  
   `connect()`  
3. while(1)  
   {  
           å‘é€æ•°æ®  `write/send`   
           æ¥æ”¶æ¶ˆæ¯  `read/recv`   
   }
4. å…³é—­æ–‡ä»¶æè¿°ç¬¦  
   `close(cfd)` 

```C
  1 //å®¢æˆ·ç«¯å¼€å‘
  2 #include <stdio.h>
  3 #include <stdlib.h>
  4 #include <string.h>
  5 #include <sys/types.h>
  6 #include <unistd.h>
  7 #include <sys/socket.h>
  8 #include <arpa/inet.h>
  9 #include <ctype.h>
 10 
 11 int main()
 12 {
 13     //åˆ›å»ºsocket
 14     int cfd = socket(AF_INET, SOCK_STREAM, 0);
 15     if(cfd<0)
 16     {
 17         perror("socket error");
 18         return -1;
 19     }
 20 
 21     //è¿æ¥
 22     struct sockaddr_in serv;
 23     bzero(&serv, sizeof(serv));
 24     serv.sin_family = AF_INET;
 25     serv.sin_port = htons(8888);
 26     inet_pton(AF_INET, "127.0.0.1", &serv.sin_addr.s_addr);
 27     int ret = connect(cfd, (struct sockaddr*)&serv, sizeof(serv));
 28     if(ret<0)
 29     {
 30         perror("connect error");
 31         return -1;
 32     }
 33 
 34     int n = 0;
 35     char buf[1024];
 36     while(1)
 37     {
 38         //è¯»æ ‡å‡†è¾“å…¥
 39         memset(buf, 0x00, sizeof(buf));
 40         n = read(STDIN_FILENO, buf, sizeof(buf));
 41 
 42         //å‘é€æ•°æ®
 43         write(cfd, buf, n);
 44 
 45         //æ¥æ”¶æ•°æ®
 46         memset(buf, 0x00, sizeof(buf));
 47         n = read(cfd, buf, sizeof(buf));
 48         if(n<=0)
 49         {
 50             printf("read error or server close, n==[%d]\n", n);
 51             break;
 52         }
 53         printf("n==[%d],buf==[%s]\n", n, buf);
 54     }
 55 
 56     //å…³é—­æ–‡ä»¶æè¿°ç¬¦
 57     close(cfd);
 58 
 59     return 0;
 60 }

 >>>>æ‰§è¡Œç»“æœ
 [xfk@centos SOCKET]$ ./server 
 lfd==[3],cfd==[4]
 n==[4],buf==[xfk
 ]
 ^C
 [xfk@centos SOCKET]$ ./client 
 xfk
 n==[4],buf==[XFK
 ]
 close
 read error or server close, n==[0]
```

ã€:pill:**TEST**ã€‘`netstat` æŸ¥çœ‹ç›‘å¬çŠ¶æ€å’Œè¿æ¥çŠ¶æ€  
                      `a` æ˜¾ç¤ºæ‰€æœ‰  
                      `n` ä»¥æ•°å­—æ–¹å¼æ˜¾ç¤º  
                      `p` æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯ï¼ˆè¿›ç¨‹åå’Œè¿›ç¨‹PIDï¼‰

```Linux
[xfk@centos ~]$ netstat -anp | grep 8888
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp        0      0 0.0.0.0:8888            0.0.0.0:*               LISTEN      14243/./server      
tcp        0      0 127.0.0.1:46800         127.0.0.1:8888          ESTABLISHED 14244/./client      
tcp        0      0 127.0.0.1:8888          127.0.0.1:46800         ESTABLISHED 14243/./server
```

---
> âœï¸ [é‚¢ç¦å‡¯ (xfkcode@github)](https://github.com/xfkcode)  
> ğŸ“… **å†™äº2023å¹´2æœˆ**  